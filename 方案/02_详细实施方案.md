# 微波研发部门研发管理平台

## 详细实施方案

**文档编号**: RDP-PLAN-2026-001  
**版本**: V1.0  
**编制日期**: 2026年2月20日  
**密级**: 内部公开

---

## 目录

1. 方案概述
2. 总体架构设计
3. 技术选型方案
4. 各模块实施方案
5. 开源项目选型与对比
6. 部署架构方案
7. 分期实施计划
8. 风险与应对

---

## 1. 方案概述

### 1.1 建设思路

本方案采用"微服务 + 模块化前端"的架构策略，在统一的技术栈和基础设施之上，将9大功能模块设计为独立可部署的子系统。每个模块可由不同团队并行开发，通过统一API网关和消息总线实现模块间通信。

### 1.2 核心设计原则

| 原则 | 说明 |
|------|------|
| **离线优先（Offline-First）** | 所有依赖打包至局域网，零互联网依赖 |
| **模块独立（Module Independence）** | 每个功能模块独立仓库、独立部署、独立升级 |
| **开源优先（Open-Source First）** | 优先采用成熟开源项目，减少自研工作量 |
| **渐进交付（Progressive Delivery）** | 四期分步交付，每期可独立验收使用 |
| **本地集成（Local Integration）** | 深度融合Altium Designer、Obsidian、Zotero等本地工具 |

---

## 2. 总体架构设计

### 2.1 系统总体架构图

```
表现层 — 统一前端应用 (React + Vite + TypeScript)
├── 门户首页 | 个人工作台 | 全局搜索 | 消息中心
├── 用户管理 | 项目管理 | 项目开发 | 产品货架 | 技术货架 | 知识库 | 论坛

API 网关层 — Nginx / Traefik
├── 路由分发 | 负载均衡 | SSL终止 | 认证鉴权

业务服务层 — Go (Gin)
├── 项目管理服务 (甘特图/WBS/排程/进度跟踪/仪表盘)
├── 文件管理服务 (Gitea Git仓库 + MinIO对象存储)
├── 流程引擎服务 (Flowable / 自研BPMN)
├── 搜索服务 (MeiliSearch 中文分词/索引)
├── 用户与权限服务 (Casdoor + Casbin)
├── 知识库服务 (Wiki.js / BookStack)

数据持久层 — PostgreSQL / Redis / MeiliSearch

基础设施层 — systemd
├── 服务管理 | 日志收集 | 健康检查 | 自动备份

本地工具集成层
├── rdp:// 自定义协议 → Altium Designer / Office
├── obsidian:// 协议 → Obsidian Vault 同步
├── zotero:// 协议 → Zotero 文献库引用
```

### 2.2 单体应用架构说明

采用单体前端应用架构。所有功能模块统一在一个代码库（Monorepo）中开发，通过路由和懒加载实现模块切换。

> **关键设计决策**：采用单体前端而非微前端的核心原因是：
> 1. 用户规模仅 30-100 人，单体架构完全满足需求
> 2. 单体应用开发、调试、部署更简单，降低 30-50% 复杂度
> 3. Monorepo + 代码分割可满足多团队协作需求
> 4. 减少运行时兼容性和状态共享问题

### 2.3 数据流架构

**核心数据流架构**：

```
浏览器客户端
    ↓ HTTPS
Nginx 网关
    ↓ REST / WebSocket
业务服务集群 (Go Services)
    ↓
本地辅助程序 (协议调用)
    ↓
Gitea 服务器 (版本存储 / API)
```

**事件驱动通信（模块间）**：
- 项目创建 → 自动创建Git仓库 + Mattermost频道 + 项目文件夹
- 活动完成 → 更新项目进度 + 通知下游负责人 + 触发下一活动

---

## 3. 技术选型方案

### 3.1 核心技术栈

| 层次 | 技术选型 | 版本 | 选型理由 |
|------|----------|------|----------|
| **前端框架** | React 18 + TypeScript | 18.x / 5.x | 单体应用架构，简化复杂度；TypeScript保障代码质量 |
| **前端UI** | Ant Design 5 | 5.x | 企业级组件最丰富；中文支持最好 |
| **构建工具** | Vite 5 | 5.x | HMR极速，构建速度快 |
| **后端语言** | Go (Gin) | 1.22+ | 纯Go技术栈，单二进制部署；与Casdoor/Gitea同技术栈 |
| **关系数据库** | PostgreSQL | 16.x | 功能强大；JSON支持好；全文搜索(tsvector)满足早期需求 |
| **缓存** | Redis | 7.x | Phase 2引入，会话管理、热点缓存（可用内存缓存替代） |
| **搜索引擎** | PostgreSQL全文搜索 / MeiliSearch | — | Phase 1-2用PG全文搜索，Phase 3引入MeiliSearch |
| **Git服务** | Gitea (独立部署) | 1.22+ | Phase 2引入；轻量级自托管Git服务；Go编写 |
| **认证** | Casdoor (独立部署) | Latest | Phase 1引入；统一认证和RBAC；Go技术栈 |
| **IM** | 内置通知 / Mattermost | — | Phase 1用内置通知，Phase 3可选Mattermost |
| **文件存储** | 本地文件系统 | — | 部门级应用，文件量小，无需对象存储 |
| **服务管理** | systemd | — | 裸机部署；服务守护；自动重启 |
| **反向代理** | Nginx | 1.25+ | 成熟稳定；SSL终止；负载均衡 |

### 3.2 开源组件集成矩阵

| 功能模块 | 集成方式 | 开源项目 | Stars | 引入阶段 |
|----------|----------|----------|-------|----------|
| **用户认证/RBAC** | 独立服务 + API集成 | Casdoor + Casbin | 13K + 19.8K | Phase 1 |
| **Git版本管理** | 独立服务 + API调用 | Gitea | 53.8K | Phase 2 |
| **全文搜索(早期)** | 数据库内置 + 中文分词 | PostgreSQL tsvector + jieba | - | Phase 1-2 |
| **甘特图** | 前端组件嵌入 | gantt-task-react | 1K | Phase 2 |
| **流程引擎** | 轻量级BPMN + 并行网关 | Go实现 + bpmn-js | - | Phase 2 |
| **组织架构图** | 前端组件嵌入 | d3-org-chart | 2.3K | Phase 1 |
| **图表可视化** | 前端组件嵌入 | Apache ECharts | 64K | Phase 1 |
| **Markdown编辑** | 前端组件嵌入 | ByteMD / Milkdown | 4K+ | Phase 1 |
| **全文搜索(后期)** | 独立服务 | MeiliSearch | 52K | Phase 2 (提前引入) |
| **即时通信(可选)** | 独立部署 | Mattermost | 35.4K | Phase 3 |
| **缓存服务** | 内存缓存(早期) / Redis(后期) | go-cache / Redis | - | Phase 1 / Phase 2 |
| **监控告警** | 轻量级监控 | Prometheus + Grafana | - | Phase 2 |

### 3.3 缓存策略设计

**Phase 1: 内存缓存方案**

使用 Go 内置的 `go-cache` 或 `bigcache` 实现进程内缓存：

| 缓存场景 | 缓存内容 | TTL | 失效策略 |
|----------|----------|-----|----------|
| **用户会话** | JWT Token验证结果 | 2小时 | Token过期自动失效 |
| **权限数据** | 用户角色和权限列表 | 30分钟 | 角色变更时主动失效 |
| **项目列表** | 用户参与的项目列表 | 5分钟 | 项目创建/更新时失效 |
| **产品货架** | 产品分类树和热门产品 | 10分钟 | 产品上架时失效 |

**Phase 2: Redis缓存方案**

引入Redis后的缓存架构：

```
应用层
    ↓
L1缓存: 进程内缓存 (go-cache)
    ↓ (未命中)
L2缓存: Redis (分布式缓存)
    ↓ (未命中)
数据库: PostgreSQL
```

**Redis缓存场景**：
- 用户会话管理（支持多实例部署）
- 热点数据缓存（高频访问的项目、产品）
- 分布式锁（防止并发冲突）
- 消息队列（异步任务处理）

**缓存Key命名规范**：
```
user:session:{user_id}           # 用户会话
user:permissions:{user_id}       # 用户权限
project:list:{user_id}           # 项目列表
product:detail:{product_id}      # 产品详情
search:result:{query_hash}       # 搜索结果
```

---

## 4. 各模块实施方案

### 4.1 门户界面模块

**实施策略**：
基于 Paniche/department_homepage 的 React + Vite + TypeScript 技术栈进行扩展，增加工作台功能。采用单体应用架构，通过路由和懒加载实现模块切换。

**参考开源项目**：

1. **Ant Design Pro** (37K+)
   - 蚂蚁金服出品的企业级中后台前端解决方案
   - github.com/ant-design/ant-design-pro
   - 参考价值：工作台布局、全局搜索、消息通知中心的交互设计

2. **vue-vben-admin** (31.6K)
   - Vue3 + Vite + TypeScript + Shadcn UI 构建的现代化后台管理模板
   - github.com/vbenjs/vue-vben-admin
   - 参考价值：Tab页签式工作区、多主题方案

3. **vue-element-admin** (90.3K)
   - 最流行的Vue管理后台模板，基于Element UI
   - github.com/PanJiaChen/vue-element-admin
   - 参考价值：中文企业级后台的标杆设计，权限模型、仪表盘布局

**页面结构设计**：

```
src/shell/
├── layouts/
│   ├── MainLayout.tsx        # 顶部导航 + 侧边栏 + 内容区
│   ├── PortalLayout.tsx      # 门户首页布局
│   └── WorkbenchLayout.tsx   # 工作台布局
├── pages/
│   ├── portal/               # 部门首页（新闻、公告、荣誉）
│   ├── workbench/            # 个人工作台（待办、我的项目、消息）
│   └── search/               # 全局搜索结果页
├── components/
│   ├── GlobalSearch.tsx       # 全局搜索组件
│   ├── NotificationCenter.tsx # 消息通知中心
│   └── QuickActions.tsx       # 快捷操作面板
└── services/                  # API 服务层
    └── api.ts                 # API 客户端
```

### 4.2 用户管理模块

**实施策略**：
采用 Casdoor（13K Stars）作为身份认证和用户管理基础，结合 Casbin（19.8K Stars）实现细粒度RBAC权限控制。在此基础上自研GitHub风格的个人Profile页面。

**参考开源项目**：

1. **Casdoor** (13K)
   - UI优先的IAM/SSO平台，内置组织/团队管理、多因素认证、130+社交登录支持
   - github.com/casdoor/casdoor
   - 集成方式：独立二进制部署，通过OAuth2/OIDC与主平台对接；组织/角色数据通过API同步

2. **d3-org-chart** (2.3K)
   - 基于D3.js的高度可定制组织架构图组件，支持React/Vue/Angular
   - github.com/bumbeishvili/org-chart
   - 用途：组织架构树可视化，团队成员关系展示

**个人Profile页面设计（类GitHub）**：

```
┌─────────────────────────────────────────────────────────────┐
│  [头像]  张三                    [能力雷达图 (ECharts)]      │
│         高级工程师                设计·仿真·测试·文档·创新·协作  │
│         技术开发 · 射频设计                                    │
│         微带天线 · GaN功放                                     │
│         参与项目: 12 | 专利: 3                                 │
│         入职 2019-07 · 7年经验                                │
├─────────────────────────────────────────────────────────────┤
│ [贡献热力图]                  [项目履历]                      │
│ 近12月                        - X波段TR组件 — 技术负责人 — 进行中  │
│                               - Ka波段接收前端 — 射频设计师 — 2025-12 完成 │
│                               - 宽带数字接收机 — 射频设计师 — 2025-06 完成 │
├─────────────────────────────────────────────────────────────┤
│ [荣誉: 部门技术能手(2025) | 发明专利3项 | 论文5篇]              │
└─────────────────────────────────────────────────────────────┘
```

### 4.3 项目管理模块

**实施策略**：
以自研为主，参考 Plane（45.8K Stars）和 OpenProject（14.4K Stars）的功能架构。甘特图采用 gantt-task-react 组件。文件管理通过 Gitea API实现Git版本控制。

**参考开源项目**：

1. **Plane** (45.8K)
   - 现代化的开源项目管理工具，支持Issue跟踪、Sprint、甘特图、文档等
   - github.com/makeplane/plane
   - 参考价值：项目看板、Issue管理、Sprint面板的UI/UX设计；API设计规范

2. **OpenProject** (14.4K)
   - 企业级开源项目管理软件，被西门子、德铁等大型企业使用
   - github.com/opf/openproject
   - 参考价值：甘特图交互设计、WBS分解、资源日历、MS Project导入导出

3. **禅道 (Zentao)** (1.6K 开源版)
   - 国产开源项目管理软件，16年迭代，覆盖产品、项目、质量、效能管理
   - github.com/easysoft/zentaopms
   - 参考价值：IPD流程模板、中国企业项目管理最佳实践、批量导入导出

4. **Gitea** (53.8K)
   - 轻量级自托管Git服务，Go编写，单二进制部署
   - github.com/go-gitea/gitea
   - 集成方式：每个项目自动创建Gitea仓库；通过API实现文件上传/下载/版本管理；自动commit

**项目创建向导流程**：

```
Step 1: 基本信息录入
  ├── 名称/编号/负责人
  └── 名称唯一；编号格式: RDP-{CATEGORY}-{YYYYMMDD}-{SEQ}
  
Step 2: 类别选择
  ├── 单机/模块/技术/...
  └── 选择后自动推荐匹配的流程模板
  
Step 3: 流程绑定
  ├── 自动匹配流程模板
  └── 流程选定后，活动列表自动生成
  
Step 4: 团队分配
  ├── 从用户列表选择；可搜索
  └── 项目负责人/技术负责人/产品负责人/质量负责人/成员列表
  
Step 5: 计划确认
  ├── 活动列表(含工期/负责人)
  ├── 甘特图预览
  └── 确认创建
```

**创建后自动触发**：
- [MUST] 创建Gitea仓库（仓库名=项目编号）
- [MUST] 初始化标准目录结构到Git仓库
- [MUST] 根据流程模板，复制模板文件到对应目录（如空白原理图、设计方案模板等）
- [MUST] 生成项目活动实例（基于流程模板）
- [SHOULD] 发送项目创建通知给所有成员

**本地同步**（桌面辅助程序）：
- [MUST] 检测到新项目创建 → 自动clone到本地工作目录
- [SHOULD] 弹出桌面通知提示用户项目已就绪

### 4.4 项目开发模块

**实施策略**：
自研为主，流程引擎参考 Flowable（9K Stars）的BPMN规范设计轻量级Go实现。流程可视化采用 bpmn.js。本地工具集成通过自研桌面辅助程序（Electron/Tauri）实现自定义协议注册和文件监听。

**参考开源项目**：

1. **Flowable Engine** (9K)
   - 高性能BPMN 2.0流程引擎，支持流程设计、人工任务、定时任务、事件驱动等完整工作流能力
   - github.com/flowable/flowable-engine
   - 参考价值：BPMN流程建模规范、活动-网关-事件模型、流程实例管理API设计

2. **n8n** (175K+)
   - 可视化工作流自动化平台，400+集成，支持自托管
   - github.com/n8n-io/n8n
   - 集成方式：流程开发类项目直接嵌入n8n的流程设计器进行可视化流程编排

**本地工具集成架构（本地工作目录模式）**：

```
项目创建与同步流程:
┌──────────────────────────────────────────────────────────────┐
│ 1. 用户在Web端创建项目                                        │
│ 2. 服务器创建Gitea仓库 + 初始化目录结构 + 流程模板文件          │
│ 3. 桌面辅助程序自动clone到本地工作目录                         │
└──────────────────────────┬───────────────────────────────────┘
                           │
                           ▼
日常开发流程:
┌──────────────────────────────────────────────────────────────┐
│ Web端显示文件列表                                           │
│    ↓ 点击文件                                               │
│ rdp://open?project={id}&path={文件相对路径}                  │
│    ↓                                                        │
│ 桌面辅助程序解析协议，定位本地文件                             │
│    ↓                                                        │
│ 调用本地软件打开文件 (Altium/Office/Obsidian等)              │
│    ↓ 用户编辑保存                                            │
│ 用户在辅助程序中手动提交Git（可写提交说明）                     │
│    ↓ git commit + push                                       │
│ 服务器Gitea仓库更新                                          │
└──────────────────────────────────────────────────────────────┘
```

**桌面辅助程序职责**：
1. [MUST] 注册 `rdp://` 协议处理程序
2. [MUST] 维护本地工作目录（自动clone/pull项目）
3. [MUST] 解析协议，定位本地文件，调用对应软件
4. [MUST] **活动完成时自动Git提交**：接收Web端通知，自动commit + push
5. [SHOULD] 提供手动Git提交界面（用于非活动完成时的提交）
6. [SHOULD] 同步状态提示（已同步/有待提交变更）

**自动提交规则**：
- 触发条件：用户点击"活动完成"且通过完成校验
- Commit范围：该活动输出物相关的文件变更（根据活动定义的输出路径模式匹配）
- Commit message：`完成活动"{活动名称}"：{项目编号}-{活动编号}`
- 提交前预览：强制显示变更文件列表，用户确认后提交

**完整链路**:
- 日常开发：点击文件 → 本地软件编辑 → 手动保存（不提交）
- 活动完成：点击"活动完成" → 自动Git提交 → 触发下一活动

#### 4.4.1 rdp:// 协议注册技术方案

**协议格式规范**：
```
rdp://open?project={project_id}&path={relative_path}&type={file_type}

示例:
rdp://open?project=RDP-001&path=03-设计文件/原理图/main.schdoc&type=altium
rdp://open?project=RDP-001&path=02-设计文档/方案.md&type=markdown
```

**跨平台协议注册实现**：

| 平台 | 注册方式 | 实现细节 |
|------|----------|----------|
| **Windows** | 注册表 | 写入 `HKEY_CLASSES_ROOT\rdp\shell\open\command`<br>值: `"C:\Program Files\RDP\rdp-helper.exe" "%1"` |
| **macOS** | Info.plist | 在应用Bundle的Info.plist中注册 `CFBundleURLSchemes`<br>系统自动关联到应用 |
| **Linux** | .desktop文件 | 创建 `~/.local/share/applications/rdp-handler.desktop`<br>注册 `MimeType=x-scheme-handler/rdp` |

**桌面辅助程序技术栈选型**：

| 方案 | 优势 | 劣势 | 推荐度 |
|------|------|------|--------|
| **Electron** | 跨平台一致性好，Web技术栈，生态丰富 | 包体积大(~150MB)，内存占用高 | ⭐⭐⭐⭐ |
| **Tauri** | 包体积小(~10MB)，性能好，Rust后端 | 生态较新，Windows需安装WebView2 | ⭐⭐⭐⭐⭐ |
| **Qt/C++** | 性能最优，包体积可控 | 开发效率低，跨平台兼容性需测试 | ⭐⭐⭐ |

**推荐方案**：**Tauri** (Rust + Web前端)
- 包体积小，适合内网分发
- 性能优于Electron
- 支持系统托盘、自定义协议、文件监听等核心功能

**降级方案（无桌面程序时）**：
- Web端检测协议调用失败（超时3秒）
- 显示提示："未检测到桌面辅助程序，请[下载安装](link)或使用[Web端上传/下载](fallback)"
- 提供Web端文件上传/下载功能作为备用方案

#### 4.4.2 Git冲突检测与解决机制

**冲突场景**：
1. 多人同时编辑同一文件
2. 本地修改未提交，服务器已有新提交
3. 网络中断导致push失败

**冲突检测流程**：
```
活动完成触发提交
    ↓
桌面程序执行 git pull --rebase
    ↓
如有冲突 → 暂停提交
    ↓
显示冲突文件列表
    ↓
用户选择：
    ├─ 保留本地版本 (git checkout --ours)
    ├─ 保留服务器版本 (git checkout --theirs)
    └─ 手动合并 (打开Merge工具)
    ↓
解决后继续 git rebase --continue
    ↓
git push
```

**冲突解决策略**：

| 冲突类型 | 自动处理策略 | 用户操作 |
|----------|-------------|----------|
| **非关键文件冲突** | 自动保留本地版本 | 无需操作 |
| **活动输出文件冲突** | 暂停，提示用户 | 选择保留版本或手动合并 |
| **Push失败（网络）** | 自动重试3次 | 失败后提示手动重试 |

**活动状态处理**：
- 提交成功：活动状态 → "completed"，触发下一活动
- 提交失败：活动状态保持 "in_progress"，显示错误信息，允许重试
- 冲突未解决：活动状态保持 "in_progress"，显示"Git冲突待解决"标签

### 4.5 产品/技术货架模块

**实施策略**：
自研为主，产品展示UI参考电商平台的卡片式浏览和筛选交互。产品数据管理参考Part-DB（电子元器件数据库）。技术树可视化采用 ECharts Tree 或 D3.js。

**参考开源项目**：

1. **Part-DB** (1.5K)
   - 开源电子元器件数据库管理系统，支持参数化搜索、分类管理、数据手册关联、库存管理等
   - github.com/Part-DB/Part-DB-server
   - 参考价值：电子元器件分类体系、参数化搜索、数据手册管理的交互设计

### 4.6 知识库模块

**实施策略**：
知识库底层架构参考 Wiki.js（27K Stars）或 BookStack（17K Stars），在此基础上自研Obsidian Vault同步和Zotero引用集成。全文搜索基于 MeiliSearch。

**参考开源项目**：

1. **Wiki.js** (27K)
   - 功能最完善的开源Wiki引擎，支持Markdown/WYSIWYG编辑、Git同步、多语言、模块化存储、全文搜索等
   - github.com/requarks/wiki
   - 参考价值：知识分类体系、Git同步机制、全文搜索集成、权限管理

2. **BookStack** (17K)
   - 层级化知识管理平台（Shelves → Books → Chapters → Pages），非常适合标准规范、制度文件等结构化文档管理
   - github.com/BookStackApp/BookStack
   - 参考价值：书架→书→章→页的层级结构，完美对应知识库的分类体系需求

3. **Quartz (Obsidian发布)** (10K)
   - 将Obsidian Vault发布为静态网站，支持Wiki链接、Callout、嵌入、图谱等Obsidian特有语法
   - github.com/jackyzha0/quartz
   - 参考价值：Obsidian Markdown渲染引擎的实现参考，Wiki链接解析逻辑

### 4.7 即时通信模块

**实施策略**：
直接部署 Mattermost 团队版（MIT许可），通过iframe嵌入或API集成到平台工作台中。利用Webhook实现项目状态变更自动推送。

**参考开源项目**：

1. **Mattermost** (35.4K)
   - 企业级开源协作平台，Go+React，支持频道、私聊、文件共享、700+集成、Bot框架等
   - github.com/mattermost/mattermost
   - 集成方式：独立二进制部署 → Nginx反向代理集成 → SSO与Casdoor对接 → Webhook接收项目事件

**自动化集成**：

```javascript
// 项目创建后自动执行:
1. POST /api/v4/channels → 创建频道 (name=project-{code})
2. POST /api/v4/channels/{id}/members → 添加项目成员
3. POST /api/v4/posts → 发送欢迎消息 "项目{name}已创建，欢迎团队成员！"

// 项目状态变更时:
POST /hooks/{webhook_id} → "项目{name}状态更新为{status}"
```

---

## 5. 开源项目选型与对比总览

| 功能域 | 推荐方案 | 备选方案 | 决策理由 | 引入阶段 |
|--------|----------|----------|----------|----------|
| **前端框架** | React + Vite + TS | Vue 3 + Vite | 成熟稳定，生态丰富 | Phase 1 |
| **UI组件库** | Ant Design 5 | Shadcn/Element Plus | 企业级组件丰富，中文支持好 | Phase 1 |
| **后端框架** | Go (Gin) | Go (Fiber) | 纯Go技术栈，单二进制部署 | Phase 1 |
| **用户认证** | Casdoor (13K⭐) | Keycloak | Go技术栈统一，资源占用小 | Phase 1 |
| **权限引擎** | Casbin (19.8K⭐) | 自研RBAC | 成熟稳定，多模型支持 | Phase 1 |
| **数据库** | PostgreSQL 16 | MySQL 8 | 功能强大，JSON支持好，全文搜索 | Phase 1 |
| **缓存(可选)** | Redis 7 | - | 会话管理，热点缓存 | Phase 2 |
| **Git服务** | Gitea (53.8K⭐) | Gogs | 功能完善，API丰富 | Phase 2 |
| **全文搜索(早期)** | PostgreSQL tsvector | - | 无需额外组件，满足早期需求 | Phase 1-2 |
| **甘特图** | gantt-task-react | frappe-gantt | TypeScript/React原生 | Phase 2 |
| **流程引擎** | 自研轻量BPMN(Go) | Flowable | Go技术栈统一，按需裁剪 | Phase 2 |
| **图表库** | Apache ECharts | Chart.js | 覆盖全场景图表 | Phase 1 |
| **组织架构** | d3-org-chart | 自研SVG | 开箱即用，React集成好 | Phase 1 |
| **全文搜索(后期)** | MeiliSearch (52K⭐) | Elasticsearch | 轻量级，中文分词好 | Phase 3 |
| **即时通信(可选)** | Mattermost (35.4K⭐) | Rocket.Chat | Go+React技术栈 | Phase 3 |

---

## 6. 部署架构方案

### 6.1 局域网部署架构图

```
设计师工作站 (浏览器 + 辅助程序)
    ↓
Nginx 反向代理
    ├── TLS终止 | 路由分发 | 静态资源
    ↓
systemd 服务集群（局域网服务器）
    ├── RDP API (Go二进制, systemd管理)
    ├── 流程引擎 (Go二进制, systemd管理)
    ├── Casdoor (Go二进制, systemd管理)
    ├── Gitea (Go二进制, systemd管理)
    ├── Mattermost (Go二进制, systemd管理)
    ├── MeiliSearch (Rust二进制, systemd管理)
    ├── PostgreSQL 16 (系统服务)
    ├── Redis 7 (系统服务)
    └── MinIO (可选, Go二进制, systemd管理)
    
定时备份服务 (每日全量 + 增量, systemd timer)
```

**硬件要求**: 8核CPU / 32GB内存 / 1TB SSD / 千兆网络  
**操作系统**: Ubuntu Server 22.04 LTS / CentOS 8+ / 麒麟OS

### 6.2 systemd 服务部署方案

#### 6.2.1 安装目录结构

```
/opt/rdp/
├── bin/                    # 可执行文件
│   ├── rdp-api            # 主 API 服务
│   ├── casdoor            # 认证服务
│   ├── gitea              # Git 服务
│   ├── mattermost         # IM 服务
│   └── meilisearch        # 搜索服务
├── config/                 # 配置文件
│   ├── rdp-api.yaml
│   ├── casdoor.conf
│   └── nginx.conf
├── data/                   # 数据目录
│   ├── postgresql/        # 数据库数据
│   ├── redis/             # 缓存数据
│   ├── gitea/             # Git 仓库
│   ├── mattermost/        # IM 数据
│   └── meilisearch/       # 搜索索引
├── logs/                   # 日志目录
├── scripts/                # 运维脚本
│   ├── install.sh         # 安装脚本
│   ├── backup.sh          # 备份脚本
│   └── health-check.sh    # 健康检查
└── web/                   # 前端静态文件
    ├── portal/            # 门户前端
    └── modules/           # 子模块前端
```

#### 6.2.2 核心服务 systemd 配置示例

**RDP API 服务** (`/etc/systemd/system/rdp-api.service`):

```ini
[Unit]
Description=RDP API Server
After=network.target postgresql.service redis.service
Wants=postgresql.service redis.service

[Service]
Type=simple
User=rdp
Group=rdp
WorkingDirectory=/opt/rdp
ExecStart=/opt/rdp/bin/rdp-api -config /opt/rdp/config/rdp-api.yaml
Restart=always
RestartSec=5

# 健康检查
ExecStartPost=/bin/sleep 3
ExecStartPost=/usr/bin/curl -f http://localhost:8080/api/v1/health || exit 1

# 资源限制
LimitNOFILE=65536
MemoryMax=2G
CPUQuota=200%

# 日志输出
StandardOutput=journal
StandardError=journal
SyslogIdentifier=rdp-api

[Install]
WantedBy=multi-user.target
```

# 资源限制
LimitNOFILE=65536
MemoryMax=2G
CPUQuota=200%

# 日志输出
StandardOutput=journal
StandardError=journal
SyslogIdentifier=rdp-api

[Install]
WantedBy=multi-user.target
```

**Casdoor 服务** (`/etc/systemd/system/rdp-casdoor.service`):

```ini
[Unit]
Description=Casdoor Identity Provider
After=network.target postgresql.service
Wants=postgresql.service

[Service]
Type=simple
User=rdp
Group=rdp
WorkingDirectory=/opt/rdp/casdoor
ExecStart=/opt/rdp/bin/casdoor
Restart=always
RestartSec=5
Environment="PATH=/opt/rdp/bin:/usr/local/bin:/usr/bin"

StandardOutput=journal
StandardError=journal
SyslogIdentifier=rdp-casdoor

[Install]
WantedBy=multi-user.target
```

**Gitea 服务** (`/etc/systemd/system/rdp-gitea.service`):

```ini
[Unit]
Description=Gitea Git Service
After=network.target postgresql.service
Wants=postgresql.service

[Service]
Type=simple
User=git
Group=git
WorkingDirectory=/opt/rdp/gitea
ExecStart=/opt/rdp/bin/gitea web -c /opt/rdp/config/gitea.ini
Restart=always
RestartSec=5

StandardOutput=journal
StandardError=journal
SyslogIdentifier=rdp-gitea

[Install]
WantedBy=multi-user.target
```

#### 6.2.3 服务管理命令

```bash
# 查看所有 RDP 服务状态
systemctl list-units --type=service --state=running | grep rdp

# 启动/停止/重启服务
sudo systemctl start rdp-api
sudo systemctl stop rdp-api
sudo systemctl restart rdp-api

# 查看服务状态
sudo systemctl status rdp-api

# 查看服务日志
journalctl -u rdp-api -f
journalctl -u rdp-api --since "1 hour ago"

# 启用/禁用开机自启
sudo systemctl enable rdp-api
sudo systemctl disable rdp-api

# 重新加载 systemd 配置
sudo systemctl daemon-reload
```

#### 6.2.4 离线安装包结构

```
rdp-offline-installer/
├── install.sh              # 主安装脚本
├── uninstall.sh            # 卸载脚本
├── README.md               # 安装说明
├── config/                 # 默认配置文件
│   ├── rdp-api.yaml
│   ├── casdoor.conf
│   ├── gitea.ini
│   ├── nginx.conf
│   └── systemd/
│       ├── rdp-api.service
│       ├── rdp-casdoor.service
│       ├── rdp-gitea.service
│       ├── rdp-mattermost.service
│       └── rdp-meilisearch.service
├── bin/                    # 预编译二进制文件
│   ├── rdp-api
│   ├── casdoor
│   ├── gitea
│   ├── mattermost
│   └── meilisearch
├── web/                    # 前端构建产物
│   ├── portal/
│   └── modules/
├── sql/                    # 数据库初始化脚本
│   ├── init.sql
│   └── migrations/
├── deps/                   # 离线依赖包
│   ├── go-modules/         # Go依赖包
│   ├── npm-packages/       # npm依赖包
│   └── system-packages/    # 系统包(deb/rpm)
│       ├── postgresql-16.deb
│       ├── redis-7.deb
│       └── nginx-1.25.deb
└── docs/                   # 安装文档
    ├── INSTALL.md          # 安装指南
    ├── UPGRADE.md          # 升级指南
    └── TROUBLESHOOTING.md  # 故障排查

```

#### 6.2.5 一键安装脚本示例

**install.sh 核心逻辑**：

```bash
#!/bin/bash
set -e

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}RDP 离线安装脚本 V1.0${NC}"
echo -e "${GREEN}========================================${NC}"

# 1. 环境检查
echo -e "${YELLOW}[1/8] 检查系统环境...${NC}"
if [ "$EUID" -ne 0 ]; then
   echo -e "${RED}错误: 请使用 sudo 运行此脚本${NC}"
   exit 1
fi

# 检查操作系统
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
    VER=$VERSION_ID
else
    echo -e "${RED}错误: 无法识别操作系统${NC}"
    exit 1
fi

echo -e "${GREEN}✓ 系统: $OS $VER${NC}"

# 2. 安装系统依赖
echo -e "${YELLOW}[2/8] 安装系统依赖...${NC}"
if [ "$OS" = "ubuntu" ] || [ "$OS" = "debian" ]; then
    dpkg -i deps/system-packages/*.deb
elif [ "$OS" = "centos" ] || [ "$OS" = "rhel" ]; then
    rpm -ivh deps/system-packages/*.rpm
fi
echo -e "${GREEN}✓ 系统依赖安装完成${NC}"

# 3. 创建用户和目录
echo -e "${YELLOW}[3/8] 创建用户和目录...${NC}"
useradd -r -s /bin/bash -d /opt/rdp rdp || true
mkdir -p /opt/rdp/{bin,config,data,logs,web}
mkdir -p /opt/rdp/data/{postgresql,redis,gitea,mattermost,meilisearch}
chown -R rdp:rdp /opt/rdp
echo -e "${GREEN}✓ 用户和目录创建完成${NC}"

# 4. 复制二进制文件
echo -e "${YELLOW}[4/8] 复制二进制文件...${NC}"
cp bin/* /opt/rdp/bin/
chmod +x /opt/rdp/bin/*
echo -e "${GREEN}✓ 二进制文件复制完成${NC}"

# 5. 复制配置文件
echo -e "${YELLOW}[5/8] 复制配置文件...${NC}"
cp config/*.{yaml,conf,ini} /opt/rdp/config/
cp config/systemd/*.service /etc/systemd/system/
cp config/nginx.conf /etc/nginx/sites-available/rdp.conf
ln -sf /etc/nginx/sites-available/rdp.conf /etc/nginx/sites-enabled/
echo -e "${GREEN}✓ 配置文件复制完成${NC}"

# 6. 初始化数据库
echo -e "${YELLOW}[6/8] 初始化数据库...${NC}"
sudo -u postgres psql -c "CREATE DATABASE rdp;"
sudo -u postgres psql -c "CREATE USER rdp WITH PASSWORD 'rdp_password';"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE rdp TO rdp;"
sudo -u postgres psql rdp < sql/init.sql
echo -e "${GREEN}✓ 数据库初始化完成${NC}"

# 7. 启动服务
echo -e "${YELLOW}[7/8] 启动服务...${NC}"
systemctl daemon-reload
systemctl enable rdp-api rdp-casdoor
systemctl start rdp-api rdp-casdoor
systemctl restart nginx
echo -e "${GREEN}✓ 服务启动完成${NC}"

# 8. 健康检查
echo -e "${YELLOW}[8/8] 健康检查...${NC}"
sleep 5
if curl -f http://localhost:8080/api/v1/health > /dev/null 2>&1; then
    echo -e "${GREEN}✓ RDP API 服务正常${NC}"
else
    echo -e "${RED}✗ RDP API 服务异常${NC}"
fi

if curl -f http://localhost:8000/api/health > /dev/null 2>&1; then
    echo -e "${GREEN}✓ Casdoor 服务正常${NC}"
else
    echo -e "${RED}✗ Casdoor 服务异常${NC}"
fi

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}安装完成！${NC}"
echo -e "${GREEN}========================================${NC}"
echo -e "访问地址: http://$(hostname -I | awk '{print $1}')"
echo -e "默认管理员: admin / admin123"
echo -e "请及时修改默认密码！"
```

#### 6.2.6 监控告警方案

**Prometheus + Grafana 轻量级监控**

**架构**：
```
RDP Services (提供 /metrics 端点)
    ↓
Prometheus (采集指标)
    ↓
Grafana (可视化展示)
    ↓
AlertManager (告警通知)
```

**监控指标**：

| 服务 | 监控指标 | 告警阈值 |
|------|----------|----------|
| **RDP API** | HTTP请求数、响应时间、错误率、内存使用 | 响应时间>2s, 错误率>5% |
| **PostgreSQL** | 连接数、慢查询、磁盘使用 | 连接数>80%, 慢查询>10/min |
| **Redis** | 内存使用、命中率、连接数 | 内存>80%, 命中率<70% |
| **Gitea** | 仓库数、推送频率、存储空间 | 存储>80% |
| **系统** | CPU、内存、磁盘、网络 | CPU>80%, 内存>85%, 磁盘>90% |

**Prometheus配置示例** (`/opt/rdp/config/prometheus.yml`):

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'rdp-api'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/metrics'

  - job_name: 'postgresql'
    static_configs:
      - targets: ['localhost:9187']

  - job_name: 'redis'
    static_configs:
      - targets: ['localhost:9121']

  - job_name: 'node'
    static_configs:
      - targets: ['localhost:9100']
```

**告警规则示例** (`/opt/rdp/config/alert-rules.yml`):

```yaml
groups:
  - name: rdp_alerts
    interval: 30s
    rules:
      - alert: HighResponseTime
        expr: http_request_duration_seconds{quantile="0.95"} > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API响应时间过高"
          description: "95分位响应时间超过2秒"

      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "API错误率过高"
          description: "5xx错误率超过5%"

      - alert: DatabaseConnectionHigh
        expr: pg_stat_database_numbackends / pg_settings_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "数据库连接数过高"
          description: "连接数超过最大值的80%"
```

---

## 7. AI Agent集群自主开发计划

> **⚠️ 开发模式声明**：本项目采用**纯AI Agent集群自主开发 + 人类监督**模式
> 
> - **零人工编码**：所有代码由AI Agent编写，人类仅做监督和决策
> - **Subagent并行**：12个功能Subagent并行开发，最大化效率
> - **三层架构**：协调层（3个Agent）+ 实现层（12个Subagent）+ 人类监督层
> - **详见 `AGENTS.md` 完整定义**

### 7.1 三层Agent架构

```
┌─────────────────────────────────────────────────────────────┐
│                    人类监督者（你）                          │
│              需求确认 | 方案决策 | 验收把关                  │
└─────────────────────────┬───────────────────────────────────┘
                          │
          ┌───────────────┼───────────────┐
          ▼               ▼               ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│  Architect  │   │   PM-Agent  │   │  Reviewer   │
│   Agent     │   │  (项目经理)  │   │   Agent     │
│  (架构师)   │   │             │   │  (审查员)   │
└──────┬──────┘   └──────┬──────┘   └──────┬──────┘
       │                 │                 │
       └─────────────────┼─────────────────┘
                         │
         ┌───────────────┼───────────────┐
         ▼               ▼               ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│  Feature    │   │  Feature    │   │  Feature    │
│   Agents    │   │   Agents    │   │   Agents    │
│ (功能子代理) │   │ (功能子代理) │   │ (功能子代理) │
└─────────────┘   └─────────────┘   └─────────────┘
```

**协调层职责**：
| Agent | 职责 | 向人类汇报 |
|-------|------|-----------|
| **Architect Agent** | 技术选型、接口定义、数据模型、编码规范 | 方案决策 |
| **PM-Agent** | 任务分解、进度跟踪、依赖管理、冲突调解 | 进度汇报 |
| **Reviewer Agent** | 代码审查、合规检查、测试验证、质量报告 | 质量评估 |

### 7.2 四期实施路线图（Subagent并行开发）

#### Phase 1：基础骨架（完全并行）

**启动指令**（4个Subagent同时启动）：

```yaml
# PortalAgent 启动指令
agent: PortalAgent
module: 门户界面
tech: React + TS + Ant Design + Vite
tasks:
  - 部门门户首页
  - 个人工作台
  - 全局搜索UI
  - 消息通知中心
deliverables:
  - 前端源代码
  - 组件文档
  - 静态构建产物
reviewer: Reviewer Agent
parallel: true  # 可并行
```

```yaml
# UserAgent 启动指令
agent: UserAgent
module: 用户管理
tech: Go + Gin + Casdoor + Casbin
tasks:
  - 用户CRUD API
  - RBAC权限模型
  - 组织架构管理
  - GitHub风格Profile页
deliverables:
  - 后端API代码
  - 权限模型实现
  - API文档
reviewer: Reviewer Agent
parallel: true
```

```yaml
# ProjectAgent 启动指令
agent: ProjectAgent
module: 项目管理
tech: Go + Gin + PostgreSQL
tasks:
  - 项目CRUD API
  - 五步创建向导
  - 基础文件管理
  - 数据库设计
deliverables:
  - 后端API代码
  - 数据库迁移脚本
  - API文档
reviewer: Reviewer Agent
parallel: true
```

```yaml
# InfraAgent 启动指令
agent: InfraAgent
module: 基础设施
tech: Shell + systemd + Nginx
tasks:
  - 数据库初始化脚本
  - systemd服务配置
  - Nginx反向代理配置
  - 一键安装脚本
deliverables:
  - deploy/目录完整配置
  - install.sh安装脚本
  - 运维文档
reviewer: Reviewer Agent
parallel: true
```

**Phase 1 里程碑**：可登录使用的基础平台  
**人类验收点**：你审查4个Subagent交付物，确认后进入Phase 2

---

#### Phase 2：核心业务（分层并行）

**Layer 1 - 基础依赖（并行）**：
```yaml
# WorkflowAgent
agent: WorkflowAgent
module: 流程引擎
dependencies: []  # 新模块，无依赖
tasks:
  - 状态机引擎
  - 流程模板管理
  - 活动流转逻辑
  - DCP评审节点
```

```yaml
# ProjectAgent (Phase 2扩展)
agent: ProjectAgent
module: 项目管理-Gitea集成
dependencies: [ProjectAgent_Phase1]  # 依赖Phase 1成果
tasks:
  - Gitea API集成
  - Git仓库自动创建
  - 文件版本管理
```

**Layer 2 - 上层模块（依赖Layer 1）**：
```yaml
# DevAgent
agent: DevAgent
module: 项目开发
dependencies: [WorkflowAgent, ProjectAgent]  # 依赖流程和项目
tasks:
  - 流程全景视图
  - 活动执行面板
  - 本地软件联动(rdp协议)
  - Git自动提交集成
```

```yaml
# ShelfAgent
agent: ShelfAgent
module: 产品/技术货架
dependencies: [ProjectAgent]  # 依赖项目基础
tasks:
  - 产品分类浏览
  - 技术树展示
  - 选用购物车
  - 版本管理
```

```yaml
# DesktopAgent
agent: DesktopAgent
module: 桌面辅助程序
tech: Tauri + Rust
dependencies: [DevAgent]  # 依赖开发模块协议定义
tasks:
  - rdp://协议注册
  - 本地软件调用
  - Git自动提交
  - 冲突处理UI
```

**Phase 2 里程碑**：完整研发管理流程上线  
**人类验收点**：你测试完整开发流程，确认后进入Phase 3

---

#### Phase 3：知识智能（完全并行）

```yaml
# KnowledgeAgent
agent: KnowledgeAgent
module: 知识库
tasks:
  - 知识分类管理
  - Obsidian Vault同步
  - Zotero集成
  - Markdown渲染
```

```yaml
# SearchAgent
agent: SearchAgent
module: 搜索服务
tech: Go + MeiliSearch
tasks:
  - 全文搜索引擎
  - 中文分词
  - 索引管理
  - 搜索API
```

```yaml
# ForumAgent
agent: ForumAgent
module: 技术论坛
tasks:
  - 帖子发布/回复
  - 板块管理
  - @通知系统
  - 富文本编辑
```

**Phase 3 里程碑**：知识管理体系上线  
**人类验收点**：你验证知识沉淀和搜索功能，确认后进入Phase 4

---

#### Phase 4：优化完善（完全并行）

```yaml
# AnalyticsAgent
agent: AnalyticsAgent
module: 数据分析
tasks:
  - 数据仪表盘
  - 统计报表
  - 数据可视化
```

```yaml
# 各Feature Agent优化任务
agents: [PortalAgent, UserAgent, ProjectAgent, ...]
tasks:
  - 性能优化
  - 用户体验提升
  - Bug修复
  - 文档完善
```

**Phase 4 里程碑**：全功能稳定版本  
**人类验收点**：你最终验收，项目完成

### 7.3 Subagent开发工作流

#### 标准执行流程

```
Phase X 启动
    │
    ├──→ 你确认阶段范围
    │
    ▼
PM-Agent分解任务
    │
    ├──→ 生成各Subagent启动指令
    │
    ▼
Architect Agent设计规范
    │
    ├──→ 输出接口定义、数据模型、编码规范
    │
    ▼
并行启动Subagent
    │
    ├──→ Subagent A ────────┐
    ├──→ Subagent B ────────┼──→ 各自开发 + 自审查(L1)
    ├──→ Subagent C ────────┘
    │
    ▼
Reviewer Agent审查
    │
    ├──→ 代码审查(L2)
    ├──→ 架构合规检查
    └──→ 测试验证
    │
    ▼
PM-Agent集成测试
    │
    ├──→ 模块联调
    ├──→ 端到端测试
    └──→ 输出测试报告(L3)
    │
    ▼
你（监督者）验收
    │
    ├──→ 功能验证
    ├──→ 用户体验检查
    └──→ 业务符合度评估(L4)
    │
    ▼
决策：进入下一阶段 / 返回修改
```

#### 人类监督介入点

| 时机 | 你的动作 | Agent输出 |
|------|----------|-----------|
| Phase启动前 | 确认阶段目标和范围 | PM-Agent提供任务分解清单 |
| 方案设计时 | 选择技术方案 | Architect Agent提供2-3个选项 |
| 每完成20% | 接收进度汇报 | PM-Agent汇报各Subagent进度 |
| 遇到争议 | 做最终决策 | 相关Agent陈述方案，Architect评估 |
| Phase结束时 | 审查交付物 | Reviewer Agent提交质量报告 |

### 7.4 质量保证体系

#### 四级审查机制

| 级别 | 执行者 | 内容 | 标准 |
|------|--------|------|------|
| **L1** | Subagent自身 | 代码规范、语法、基础逻辑 | 自检查清单 |
| **L2** | Reviewer Agent | 架构合规、接口一致、安全 | 审查报告 |
| **L3** | PM-Agent | 模块协作、端到端、性能 | 测试报告 |
| **L4** | 你（监督者） | 功能完整、体验、业务符合 | 验收意见 |

#### 冲突解决机制

```
Subagent A vs B 分歧
    │
    ├──→ Architect Agent技术裁决（第1层）
    │       ├─ 成功 → 执行
    │       └─ 失败 →
    │
    ├──→ PM-Agent协调（第2层）
    │       ├─ 成功 → 执行
    │       └─ 失败 →
    │
    └──→ 上报你决策（第3层）
            └─ 最终裁决
```

**人类介入阈值**：仅在Architect和PM-Agent均无法调解时介入

---

## 8. 风险与应对

| 风险 | 等级 | 应对措施 |
|------|------|----------|
| **离线环境依赖管理复杂** | 高 | 建立离线依赖仓库；所有npm/go依赖预下载打包；二进制文件打包 |
| **单体架构复杂度可控** | 低 | Monorepo统一管理，路由懒加载实现代码分割 |
| **本地软件集成兼容性** | 中 | 桌面辅助程序做好版本适配；提供手动上传兜底方案 |
| **开源项目版本升级风险** | 低 | 锁定经过验证的版本号；建立内部Fork仓库 |
| **数据迁移和历史数据** | 中 | 设计通用导入接口；提供Excel/CSV批量导入工具 |
| **用户接受度和培训成本** | 中 | 分批培训；提供操作视频和帮助文档；设置"意见反馈"入口 |

---

**文档结束**

---

© 2026 微波研发部门 | 内部文档
