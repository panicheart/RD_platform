# 微波研发部门研发管理平台

## 需求规格说明书（SRS）

**文档编号**: RDP-SRS-2026-001  
**版本**: V1.2  
**编制日期**: 2026年2月21日  
**密级**: 内部公开  
**目标读者**: AI Agent 实现集群

> ⚠️ Agent 实现指引：本文档是面向 AI Agent 集群的需求规格说明书。每个功能规格包含明确的输入/输出/验收标准/数据模型/API规范，Agent应严格按照规格实现，不得遗漏。对于标注为 [MUST] 的条目为强制实现， [SHOULD] 为推荐实现， [MAY] 为可选实现。

---

## 目录

1. 引言
2. 系统约束与技术规范
3. 数据模型规范
4. SRS-PORTAL — 门户界面模块
5. SRS-USER — 用户管理模块
6. SRS-PM — 项目管理模块
7. SRS-DEV — 项目开发模块
   - SRS-DEV-001: 流程全景视图
   - SRS-DEV-002: 本地软件联动
   - SRS-DEV-003: 活动执行与交付
   - SRS-DEV-004: DCP评审与审批
8. SRS-SHELF — 产品货架模块
9. SRS-TECH — 技术货架模块
10. SRS-KB — 知识库模块
11. SRS-FORUM — 技术论坛模块
12. SRS-NOTIFICATION — 通知系统模块
13. SRS-IM — 即时通信模块
14. SRS-SECURITY — 安全合规模块
15. SRS-MONITOR — 运维监控模块
16. SRS-QM — 质量管理模块
17. 非功能规格
18. API 设计规范
19. 验收测试矩阵

---

## 1. 引言

### 1.1 系统标识

| 项目 | 内容 |
|------|------|
| **系统名称** | 微波研发部门研发管理平台（R&D Platform, 简称RDP） |
| **系统代号** | RDP |
| **版本目标** | V1.0（覆盖一至四期全部功能） |
| **部署环境** | 离线局域网，systemd裸机部署 |
| **用户规模** | 30-100人 |

### 1.2 Agent 实现约定

**实现顺序约定**：
1. **Phase 1** 标记的功能必须在第一批次实现（门户+用户+项目管理基础+内置通知）
2. **Phase 2** 标记的功能在第二批次实现（流程引擎+项目开发+货架）
3. **Phase 3** 标记的功能在第三批次实现（知识库+论坛+搜索）
4. **Phase 4** 标记的功能在第四批次实现（优化+高级特性）

每个功能规格包含：功能ID | 描述 | 输入 | 输出 | 前置条件 | 数据模型 | API端点 | 验收标准 | 阶段标记

---

## 2. 系统约束与技术规范

### 2.1 技术栈约束（强制）

| 层次 | 技术 | 版本约束 | 备注 |
|------|------|----------|------|
| **前端** | React + TypeScript + Vite | React 18.x, TS 5.x, Vite 5.x | [MUST] 单体应用，非微前端 |
| **前端UI** | Ant Design 5 | 5.x | [MUST] 主UI库 |
| **后端** | Go (Gin framework) | Go 1.22+, Gin 1.9+ | [MUST] 纯Go技术栈 |
| **数据库** | PostgreSQL | 16.x | [MUST] 含全文搜索功能 |
| **缓存** | Redis | 7.x | [SHOULD] Phase 2 |
| **搜索** | PostgreSQL全文搜索(早期) / MeiliSearch(后期) | MeiliSearch 1.x | [MUST] P1用PG, P3用Meili |
| **Git服务** | Gitea (独立部署) | 1.22+ | [MUST] Phase 2 |
| **认证** | Casdoor (独立部署) | Latest | [MUST] Phase 1 |
| **IM** | 内置通知(早期) / Mattermost(后期) | Team Edition | [SHOULD] P1内置, P3外接 |
| **文件存储** | 本地文件系统 | — | [MUST] |
| **部署方式** | systemd 裸机部署 | — | [MUST] |

### 2.2 编码规范约束

| 规范项 | 要求 |
|--------|------|
| **语言** | [MUST] 代码注释和变量名使用英文；UI文案使用中文（i18n机制） |
| **API风格** | [MUST] RESTful API；路径小写+连字符；版本前缀 `/api/v1/` |
| **错误处理** | [MUST] 统一错误响应格式 `{"code": int, "message": string, "data": null}` |
| **认证方式** | [MUST] JWT Bearer Token；Access Token有效期2小时；Refresh Token 7天 |
| **分页** | [MUST] 统一分页参数 `?page=1&page_size=20`；响应含 `total, page, page_size` |
| **时间格式** | [MUST] ISO 8601（UTC）：`2026-02-20T13:00:00Z` |
| **ID生成** | [MUST] 雪花算法或ULID，不使用自增ID |
| **前端状态** | [SHOULD] Zustand 或 React Context；单体应用避免 Redux |
| **CSS方案** | [SHOULD] Tailwind CSS + Ant Design 主题定制 |
| **测试覆盖** | [SHOULD] 后端核心逻辑单元测试覆盖率 ≥ 60% |

### 2.3 项目结构约束

```
rdp/                          # Monorepo根目录
├── apps/
│   └── web/                  # 统一前端应用(单体架构)
├── services/
│   └── api/                  # 后端API服务(Go + Gin)
│       ├── handlers/         # HTTP处理器
│       ├── models/           # 数据模型
│       ├── services/         # 业务逻辑
│       └── main.go           # 入口文件
├── packages/
│   ├── shared-types/         # 共享TypeScript类型定义
│   └── shared-utils/         # 共享工具函数
├── database/
│   ├── migrations/           # 数据库迁移脚本
│   └── seeds/                # 初始数据种子
├── deploy/
│   ├── systemd/              # systemd服务配置
│   ├── nginx/                # Nginx配置
│   └── scripts/              # 部署脚本
└── docs/                     # 项目文档
```

---

## 3. 数据模型规范

### 3.1 核心实体关系图（ER图）

```
User 用户
├── id: ULID [PK]
├── username: VARCHAR(50)
├── role: ENUM
├── team: ENUM
├── title: ENUM (职称)
└── skills: JSONB

Project 项目
├── id: ULID [PK]
├── name: VARCHAR(200)
├── category: ENUM
├── status: ENUM
├── process_template_id: FK
├── git_repo_id: VARCHAR
└── leader_id: FK → User

Activity 活动
├── id: ULID [PK]
├── project_id: FK → Project
├── name: VARCHAR(200)
├── status: ENUM
├── assignee_id: FK → User
└── inputs/outputs: JSONB

Product 产品(货架)
├── id: ULID [PK]
├── name: VARCHAR(200)
├── type: ENUM
├── maturity: ENUM
└── owner_id: FK → User

File 文件
├── id: ULID [PK]
├── project_id: FK → Project
├── name: VARCHAR(255)
├── path: VARCHAR(500)
├── size: BIGINT
├── mime_type: VARCHAR(100)
├── git_commit_hash: VARCHAR(40)
├── uploaded_by: FK → User
└── created_at: TIMESTAMPTZ

ProcessTemplate 流程模板
├── id: ULID [PK]
├── name: VARCHAR(200)
├── category: project_category
├── description: TEXT
├── activities: JSONB          -- 活动列表配置
├── created_by: FK → User
└── is_active: BOOLEAN

Notification 通知
├── id: ULID [PK]
├── user_id: FK → User
├── type: ENUM ('system', 'project', 'activity', 'approval')
├── title: VARCHAR(200)
├── content: TEXT
├── is_read: BOOLEAN
├── related_id: VARCHAR(50)    -- 关联对象ID
├── related_type: VARCHAR(50)  -- 关联对象类型
└── created_at: TIMESTAMPTZ

AuditLog 审计日志
├── id: ULID [PK]
├── user_id: FK → User
├── action: VARCHAR(50)        -- 操作类型
├── resource_type: VARCHAR(50) -- 资源类型
├── resource_id: VARCHAR(50)   -- 资源ID
├── old_value: JSONB
├── new_value: JSONB
├── ip_address: INET
└── created_at: TIMESTAMPTZ
```

### 3.2 数据库索引设计

**核心表索引策略**：

```sql
-- Users 表
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_team ON users(team);
CREATE INDEX idx_users_email ON users(email);

-- Projects 表
CREATE INDEX idx_projects_status ON projects(status);
CREATE INDEX idx_projects_leader_id ON projects(leader_id);
CREATE INDEX idx_projects_category ON projects(category);
CREATE INDEX idx_projects_created_at ON projects(created_at DESC);
CREATE INDEX idx_projects_code ON projects(code); -- 项目编号唯一索引

-- Activities 表
CREATE INDEX idx_activities_project_id ON activities(project_id);
CREATE INDEX idx_activities_assignee_id ON activities(assignee_id);
CREATE INDEX idx_activities_status ON activities(status);
CREATE INDEX idx_activities_project_status ON activities(project_id, status); -- 复合索引

-- ProjectMembers 表（项目成员关联表）
CREATE INDEX idx_project_members_project_id ON project_members(project_id);
CREATE INDEX idx_project_members_user_id ON project_members(user_id);
CREATE INDEX idx_project_members_composite ON project_members(project_id, user_id); -- 复合索引

-- Files 表
CREATE INDEX idx_files_project_id ON files(project_id);
CREATE INDEX idx_files_path ON files(path);
CREATE INDEX idx_files_uploaded_by ON files(uploaded_by);
CREATE INDEX idx_files_created_at ON files(created_at DESC);

-- Notifications 表
CREATE INDEX idx_notifications_user_id ON notifications(user_id);
CREATE INDEX idx_notifications_is_read ON notifications(is_read);
CREATE INDEX idx_notifications_user_unread ON notifications(user_id, is_read) WHERE is_read = false; -- 部分索引

-- AuditLog 表（审计日志）
CREATE INDEX idx_audit_log_user_id ON audit_log(user_id);
CREATE INDEX idx_audit_log_resource ON audit_log(resource_type, resource_id);
CREATE INDEX idx_audit_log_created_at ON audit_log(created_at DESC);
-- 分区策略：按月分区
CREATE TABLE audit_log_2026_01 PARTITION OF audit_log
    FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
CREATE TABLE audit_log_2026_02 PARTITION OF audit_log
    FOR VALUES FROM ('2026-02-01') TO ('2026-03-01');
-- ... 后续月份

-- Products 表（产品货架）
CREATE INDEX idx_products_type ON products(type);
CREATE INDEX idx_products_maturity ON products(maturity);
CREATE INDEX idx_products_owner_id ON products(owner_id);
CREATE INDEX idx_products_name_gin ON products USING GIN(to_tsvector('simple', name)); -- 全文搜索

-- KnowledgeItems 表（知识库）
CREATE INDEX idx_kb_tags ON knowledge_items USING GIN(tags);
CREATE INDEX idx_kb_category ON knowledge_items(category, sub_category);
CREATE INDEX idx_kb_content_fts ON knowledge_items USING GIN(to_tsvector('jiebacfg', content)); -- 中文全文搜索

-- Approvals 表（审批）
CREATE INDEX idx_approvals_activity_id ON approvals(activity_id);
CREATE INDEX idx_approvals_approver_id ON approvals(approver_id);
CREATE INDEX idx_approvals_status ON approvals(status);
CREATE INDEX idx_approvals_approver_pending ON approvals(approver_id, status) WHERE status = 'pending'; -- 部分索引
```

**索引优化说明**：
1. **复合索引**：高频组合查询使用复合索引（如 project_id + status）
2. **部分索引**：针对特定条件的查询（如未读通知、待审批）
3. **GIN索引**：用于JSONB字段、数组字段、全文搜索
4. **降序索引**：时间字段按降序创建索引，优化最新数据查询
5. **分区表**：审计日志按月分区，避免单表过大影响性能
├── ip_address: VARCHAR(45)
├── user_agent: VARCHAR(500)
└── created_at: TIMESTAMPTZ
```

### 3.2 枚举类型定义

```sql
-- 用户角色
CREATE TYPE user_role AS ENUM ('admin', 'dept_leader', 'team_leader', 'designer', 'other');

-- 团队
CREATE TYPE team_type AS ENUM ('product_mgmt', 'product_dev', 'tech_dev', 'general_mgmt');

-- 产品管理子方向
CREATE TYPE pm_specialty AS ENUM ('model_mgmt', 'reliability');

-- 产品开发产品线
CREATE TYPE pd_product_line AS ENUM ('line_a', 'line_b', 'line_c');

-- 技术开发方向
CREATE TYPE td_specialty AS ENUM ('antenna', 'rf', 'digital', 'power');

-- 设计师职称
CREATE TYPE title_level AS ENUM ('designer_junior', 'assistant_eng', 'engineer', 'senior_eng', 'researcher');

-- 项目类别
CREATE TYPE project_category AS ENUM (
  'standalone',      -- 单机
  'module',          -- 模块
  'software',        -- 软件
  'tech_dev',        -- 技术开发
  'process_dev',     -- 流程开发
  'knowledge_dev',   -- 知识库开发
  'product_launch'   -- 产品上架
);

-- 项目状态
CREATE TYPE project_status AS ENUM ('draft', 'planning', 'in_progress', 'review', 'completed', 'archived');

-- 活动状态
CREATE TYPE activity_status AS ENUM ('pending', 'in_progress', 'review', 'completed', 'blocked');

-- 产品成熟度
CREATE TYPE product_maturity AS ENUM ('developing', 'prototype', 'engineering', 'qualified', 'mass_production');

-- 产品类型(货架)
CREATE TYPE shelf_type AS ENUM ('standalone', 'module', 'software', 'basic');

-- 基础件子类
CREATE TYPE basic_subtype AS ENUM ('component', 'fastener', 'material');

-- 知识分类
CREATE TYPE knowledge_category AS ENUM (
  'theory', 'standard', 'regulation', 'process', 
  'case_positive', 'case_negative', 'simulation', 'software_guide'
);

-- TRL等级
CREATE TYPE trl_level AS ENUM ('TRL1','TRL2','TRL3','TRL4','TRL5','TRL6','TRL7','TRL8','TRL9');
```

---

## 4. SRS-PORTAL — 门户界面模块

### SRS-PORTAL-001: 部门门户首页

**Phase**: 1  
**优先级**: P0

**描述**：
[MUST] 系统默认首页，未登录用户可见。展示部门简介、新闻公告列表、荣誉展示区、快捷导航入口。

**输入**：无需认证的公开数据请求

**输出**：
- 部门简介区（可配置的富文本内容）
- 最新公告列表（最近10条，含标题、日期、摘要）
- 荣誉展示轮播（图片+文字）
- 导航卡片入口（各功能模块图标+名称）

**API端点**：
- `GET /api/v1/portal/announcements?page=1&page_size=10`
- `GET /api/v1/portal/honors`
- `GET /api/v1/portal/config` (部门简介等配置信息)

**验收标准**：
- ✅ 页面在3秒内完成首屏渲染（局域网环境）
- ✅ 公告列表支持分页加载
- ✅ 管理员可通过后台编辑门户内容
- ✅ 响应式适配1920×1080和1366×768分辨率

---

### SRS-PORTAL-002: 个人工作台

**Phase**: 1  
**优先级**: P0

**描述**：
[MUST] 用户登录后的默认页面。聚合展示个人相关的待办事项、我的项目列表、消息通知、快捷操作。

**组成部分**：

| 区域 | 内容 | 数据来源 |
|------|------|----------|
| **待办事项** | 待审批项、待完成活动、超期提醒 | 项目管理+项目开发模块 |
| **我的项目** | 当前参与项目列表，含进度百分比 | 项目管理模块 |
| **消息通知** | 未读消息数、最近5条通知 | 通知服务 |
| **快捷操作** | 新建项目、查看货架、进入知识库 | 固定配置+权限过滤 |
| **统计概览** | 本月完成任务数、贡献度排名 | 聚合统计 |

**API端点**：
- `GET /api/v1/workbench/todos` → 待办列表
- `GET /api/v1/workbench/my-projects` → 我的项目
- `GET /api/v1/workbench/notifications?unread=true` → 通知
- `GET /api/v1/workbench/stats` → 个人统计

**验收标准**：
- ✅ 登录后自动跳转到工作台
- ✅ 待办事项按紧急程度排序（超期>今日到期>即将到期）
- ✅ 点击待办可直接跳转到对应活动/审批页面
- ✅ 未读消息实时更新（WebSocket推送）

---

### SRS-PORTAL-003: 全局搜索

**Phase**: 3  
**优先级**: P1

**描述**：
[SHOULD] 顶部搜索栏，支持跨模块全文搜索。搜索范围：项目、知识库文档、产品、技术、用户、论坛帖子。

**技术实现**：
[MUST] 基于MeiliSearch实现。各模块数据变更时通过事件驱动更新搜索索引。前端使用防抖（300ms）实时搜索建议。

**API端点**：
- `GET /api/v1/search?q=关键词&scope=all|project|knowledge|product&page=1`

**验收标准**：
- ✅ 搜索响应时间 ≤ 500ms（10万条数据级别）
- ✅ 支持中文分词和拼音搜索
- ✅ 搜索结果按相关度排序，关键词高亮
- ✅ 支持按模块过滤搜索范围

---

## 5. SRS-USER — 用户管理模块

### SRS-USER-001: 用户CRUD与认证

**Phase**: 1  
**优先级**: P0

**描述**：
[MUST] 通过 Casdoor 实现用户注册、登录、Token管理。支持管理员批量导入（Excel）、单个创建、编辑、停用。首次登录强制修改密码。

**数据模型**：

```sql
TABLE users (
  id          ULID PRIMARY KEY,
  username    VARCHAR(50) UNIQUE NOT NULL,
  display_name VARCHAR(100) NOT NULL,
  email       VARCHAR(100),
  phone       VARCHAR(20),
  avatar_url  VARCHAR(500),
  role        user_role NOT NULL DEFAULT 'designer',
  team        team_type,
  specialty   VARCHAR(50),      -- 细分方向
  product_line pd_product_line, -- 产品开发适用
  title       title_level,
  skills      JSONB DEFAULT '[]',  -- ["微带天线","GaN功放"]
  honors      JSONB DEFAULT '[]',
  bio         TEXT,
  is_active   BOOLEAN DEFAULT true,
  casdoor_id  VARCHAR(100),     -- Casdoor对应ID
  created_at  TIMESTAMPTZ DEFAULT NOW(),
  updated_at  TIMESTAMPTZ DEFAULT NOW()
);
```

**API端点**：
- `POST /api/v1/auth/login` → `{username, password}` → `{access_token, refresh_token}`
- `POST /api/v1/auth/refresh` → `{refresh_token}` → `{access_token}`
- `GET /api/v1/users` → 用户列表（支持`?team=&role=&title=`筛选）
- `GET /api/v1/users/:id` → 用户详情
- `POST /api/v1/users` → 创建用户 [Admin]
- `PUT /api/v1/users/:id` → 更新用户 [Admin]
- `POST /api/v1/users/import` → Excel批量导入 [Admin]
- `PUT /api/v1/users/:id/role` → 修改角色 [Admin]

**验收标准**：
- ✅ 管理员可创建/编辑/停用用户
- ✅ Excel模板导入≥50个用户无报错
- ✅ 首次登录强制改密后方可进入系统
- ✅ 5次登录失败锁定30分钟
- ✅ JWT Token过期自动刷新，无感知

---

### SRS-USER-002: RBAC权限模型

**Phase**: 1
**优先级**: P0

**描述**：
[MUST] 基于Casbin实现5级角色权限控制。权限继承链：admin > dept_leader > team_leader > designer > other。

**权限矩阵（核心）**：

| 资源 | admin | dept_leader | team_leader | designer | other |
|------|-------|-------------|-------------|----------|-------|
| **用户管理** | CRUD | R+部分U | R(本团队) | R(自己) | R(自己) |
| **项目创建** | ✅ | ✅ | ✅ | 申请 | ❌ |
| **项目查看** | 全部 | 全部 | 本团队+参与 | 参与项目 | 公开项目 |
| **审批** | ✅ | ✅ | 本团队 | ❌ | ❌ |
| **货架管理** | CRUD | CRUD | CRU | R+选用 | R |
| **知识库** | CRUD | CRUD | CRUD | CR | R |
| **系统配置** | ✅ | 部分 | ❌ | ❌ | ❌ |

**数据权限隔离策略**：

| 隔离维度 | 规则 | 实现方式 |
|----------|------|----------|
| **团队隔离** | 设计师默认只能看到本团队项目 | SQL: `WHERE team = user.team OR user_id IN project.members` |
| **产品线隔离** | 产品开发团队按产品线隔离 | SQL: `WHERE product_line = user.product_line OR is_public = true` |
| **项目成员隔离** | 非项目成员无法查看项目详情 | SQL: `WHERE user_id IN project.members OR role IN ('admin', 'dept_leader')` |
| **敏感数据隔离** | 薪资、绩效等敏感数据仅管理员可见 | API层过滤敏感字段 |

**Casbin模型定义（增强版）**：

```ini
[request_definition]
r = sub, obj, act, team, product_line

[policy_definition]
p = sub, obj, act, team, product_line

[role_definition]
g = _, _
g2 = _, _  # 团队继承
g3 = _, _  # 产品线继承

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = g(r.sub, p.sub) && keyMatch2(r.obj, p.obj) && r.act == p.act && \
    (p.team == "*" || g2(r.team, p.team)) && \
    (p.product_line == "*" || g3(r.product_line, p.product_line))
```

**策略示例**：

```csv
# 角色策略
p, admin, /api/v1/*, *, *, *
p, dept_leader, /api/v1/projects/*, read, *, *
p, team_leader, /api/v1/projects/*, read, team_a, *
p, designer, /api/v1/projects/*, read, team_a, line_a

# 角色继承
g, user_001, admin
g, user_002, dept_leader
g, user_003, team_leader

# 团队继承
g2, team_a, tech_dev
g2, team_b, product_dev

# 产品线继承
g3, line_a, product_dev
g3, line_b, product_dev
```

**验收标准**：
- ✅ 设计师无法访问用户管理页面（403）
- ✅ 团队组长只能看到本团队成员和项目
- ✅ 产品开发团队A线设计师无法查看B线项目
- ✅ 管理员可将部门领导设为管理员角色
- ✅ 角色变更后无需重新登录即生效
- ✅ 数据权限隔离在SQL层面生效，防止API绕过

---

### SRS-USER-003: 个人Profile页面

**Phase**: 1  
**优先级**: P1

**描述**：
[SHOULD] 类GitHub个人主页。展示：头像/姓名/职称/团队、技能标签、能力雷达图(ECharts)、贡献热力图(近12月)、项目履历、荣誉列表。

**API端点**：
- `GET /api/v1/users/:id/profile` → 完整Profile数据
- `GET /api/v1/users/:id/contributions?year=2026` → 贡献热力图数据
- `GET /api/v1/users/:id/projects` → 项目履历
- `PUT /api/v1/users/:id/skills` → 更新技能标签

**贡献热力图数据结构**：

```json
{
  "data": [
    {"date": "2026-01-01", "count": 3, "details": ["完成活动x2", "提交文档x1"]},
    {"date": "2026-01-02", "count": 0, "details": []},
    ...
  ]
}
```

**验收标准**：
- ✅ 雷达图展示≥5个维度的能力评估
- ✅ 热力图按日粒度展示全年365天数据
- ✅ 项目履历按时间倒序，显示角色和状态
- ✅ 设计师可编辑自己的技能标签和个人简介

---

## 6. SRS-PM — 项目管理模块

### SRS-PM-001: 项目总览看板

**Phase**: 1  
**优先级**: P0

**描述**：
[MUST] 展示全部门项目的鸟瞰视图。支持按产品线/团队/时间范围/负责人/状态多维筛选和排序。提供列表视图和卡片视图切换。

**API端点**：
- `GET /api/v1/projects?category=&status=&team=&leader_id=&date_from=&date_to=&sort=created_at&order=desc`

**验收标准**：
- ✅ 支持≥5个筛选条件组合过滤
- ✅ 项目卡片显示：名称、负责人、状态、进度百分比、到期日
- ✅ 超期项目自动标红
- ✅ 数据按权限过滤（设计师只看到参与项目）

---

### SRS-PM-002: 五步项目创建向导

**Phase**: 1  
**优先级**: P0

**描述**：
[MUST] 引导式项目创建流程：Step1(基本信息) → Step2(类别选择) → Step3(流程绑定) → Step4(团队分配) → Step5(计划确认)。

**Step详情**：

| Step | 表单字段 | 约束 |
|------|----------|------|
| **1-基本信息** | 项目名称*, 项目编号*(自动生成可修改), 描述, 计划开始日期*, 计划结束日期* | 名称唯一；编号格式: RDP-{CATEGORY}-{YYYYMMDD}-{SEQ} |
| **2-类别选择** | 项目类别*(单选7种), 产品线(产品开发类必选) | 选择后自动推荐匹配的流程模板 |
| **3-流程绑定** | 流程模板*(从推荐列表选择或浏览全部), 预览流程图 | 流程选定后，活动列表自动生成 |
| **4-团队分配** | 项目负责人*, 技术负责人, 产品负责人, 质量负责人, 成员列表 | 从用户列表选择；可搜索 |
| **5-计划确认** | 活动列表(含工期/负责人), 甘特图预览, 确认创建 | 可调整各活动工期；确认后创建项目 |

**创建后自动触发**：
- [MUST] 生成项目标准目录结构（服务端项目空间）
- [MUST] 根据流程模板，复制模板文件到对应目录
- [MUST] 生成项目活动实例（基于流程模板）
- [SHOULD] 若已启用Gitea（Phase 2起），自动创建仓库并初始化目录
- [SHOULD] 发送项目创建通知给所有成员

**桌面辅助程序响应**（如已运行）：
- [SHOULD] 若已启用Gitea（Phase 2起），检测到新项目后自动clone到本地工作目录
- [SHOULD] 弹出通知提示用户项目已同步到本地

**API端点**：
- `POST /api/v1/projects`

**Request Body**：

```json
{
  "name": "X波段TR组件",
  "code": "RDP-STANDALONE-20260220-001",
  "category": "standalone",
  "product_line": "line_a",
  "description": "...",
  "process_template_id": "tpl_xxx",
  "start_date": "2026-03-01",
  "end_date": "2026-12-31",
  "team": {
    "leader_id": "usr_001",
    "tech_leader_id": "usr_002",
    "product_leader_id": "usr_003",
    "members": ["usr_004", "usr_005"]
  },
  "activities": [
    {"template_activity_id": "act_001", "duration_days": 10, "assignee_id": "usr_001"},
    ...
  ]
}
```

**验收标准**：
- ✅ 5步向导可前进/后退/暂存草稿
- ✅ 创建后自动生成标准目录结构和活动实例
- ✅ 若启用Gitea，项目仓库自动创建并可查询
- ✅ 流程模板绑定后活动列表正确生成

---

### SRS-PM-003: 甘特图组件

**Phase**: 2  
**优先级**: P0

**描述**：
[MUST] 基于gantt-task-react实现交互式甘特图。支持任务拖拽调整时间、依赖关系连线（FS/FF/SS/SF）、关键路径高亮、里程碑标记。

**功能列表**：
- [MUST] 按日/周/月三种时间粒度切换
- [MUST] 拖拽调整任务开始/结束时间
- [MUST] 任务依赖关系线（连线+箭头）
- [MUST] 进度条显示（按完成百分比填充）
- [SHOULD] 关键路径自动计算和高亮
- [SHOULD] 基线对比（计划vs实际）
- [MAY] MS Project (.mpp) 导入导出

**验收标准**：
- ✅ 50个任务+依赖关系的甘特图渲染 ≤ 2秒
- ✅ 拖拽修改任务时间后，依赖任务自动级联调整
- ✅ 数据变更实时持久化到后端

---

### SRS-PM-004: 项目文件夹与Git管理

**Phase**: 2  
**优先级**: P0

**描述**：
[MUST] 每个项目对应一个Gitea仓库。项目创建时自动初始化标准目录结构。支持通过Web界面浏览文件树、上传/下载文件。支持通过桌面辅助程序将项目文件夹下载至本地，本地修改后同步回服务器。

**标准目录结构**：

```
{项目编号}/
├── 01-需求文档/
├── 02-设计文档/
│   ├── 方案设计/
│   ├── 详细设计/
│   └── 仿真报告/
├── 03-设计文件/
│   ├── 原理图/
│   ├── PCB/
│   └── 结构/
├── 04-测试文档/
├── 05-评审记录/
├── 06-变更记录/
└── README.md
```

**API端点**：
- `GET /api/v1/projects/:id/files?path=/` → 文件树
- `GET /api/v1/projects/:id/files/download?path=xxx` → 下载文件
- `POST /api/v1/projects/:id/files/upload` → 上传文件
- `GET /api/v1/projects/:id/files/history?path=xxx` → 版本历史

**验收标准**：
- ✅ 项目创建后Gitea仓库含完整目录结构
- ✅ Web端可浏览文件树、查看文件内容（文本类）
- ✅ 文件上传自动创建git commit，commit message含文件名
- ✅ 版本历史列表显示每次提交的时间、作者、变更说明

---

## 7. SRS-DEV — 项目开发模块

### SRS-DEV-001: 流程全景视图

**Phase**: 2  
**优先级**: P0

**描述**：
[MUST] 以BPMN风格图形化展示项目完整开发流程。当前活动高亮标识（蓝色脉冲），已完成活动（绿色✓），未开始活动（灰色），阻塞活动（红色！）。

**交互规格**：
- [MUST] 点击任意活动节点 → 展开活动详情面板（侧边抽屉）
- [MUST] 详情面板含：活动定义、输入文档列表、输出模板列表、执行指南、参考资料
- [MUST] 进度百分比实时计算：(已完成活动数/总活动数) × 100
- [SHOULD] 支持流程图缩放和拖拽平移

**验收标准**：
- ✅ 流程图正确渲染所有活动节点和连线
- ✅ 当前活动有明显的视觉区分（动画高亮）
- ✅ 点击节点 ≤ 300ms 展开详情面板

---

### SRS-DEV-002: 本地软件联动

**Phase**: 2  
**优先级**: P0

**描述**：
[MUST] 通过自定义URL协议 `rdp://` 实现Web端点击文件后调用本地软件打开。项目创建时自动将模板文件同步到本地工作目录。

**工作流程**：
1. 项目创建 → 服务器创建Gitea仓库并初始化模板文件
2. 桌面辅助程序自动clone项目到本地工作目录
3. 用户点击Web端文件 → 调用本地软件打开本地对应文件
4. 用户编辑完成后，在辅助程序中手动提交Git

**协议规范**：

```
rdp://open?project={project_id}&path={relative_path}&type={file_type}

示例:
rdp://open?project=RDP-001&path=03-设计文件/原理图/main.schdoc&type=altium
rdp://open?project=RDP-001&path=02-设计文档/方案.md&type=markdown
```

**桌面辅助程序职责**：
1. [MUST] 注册 `rdp://` 协议处理程序
2. [MUST] 维护本地工作目录，自动clone/pull项目仓库
3. [MUST] 解析协议，根据project_id和path定位本地文件
4. [MUST] 根据file_type或扩展名调用对应本地软件
5. [MUST] **活动完成时自动Git提交**：接收Web端通知，自动commit该活动相关文件变更，push到服务器
6. [SHOULD] 提供手动Git提交界面：显示变更文件列表，支持输入commit message，执行commit+push
7. [SHOULD] 显示同步状态：已同步/有未提交变更/待pull更新

**自动提交规则**：
- 触发条件：用户点击"活动完成"且通过完成校验
- Commit范围：该活动输出物相关的所有文件变更
- Commit message：`完成活动"{活动名称}"：{项目编号}-{活动编号}`
- 提交后向Web端返回commit hash和提交时间

**移除功能**：
- 文件监听自动commit（避免产生过多无意义提交）

**文件类型映射表**：

| 扩展名 | 默认应用 | 备注 |
|--------|----------|------|
| .schdoc / .pcbdoc / .PrjPCB | Altium Designer | 直接打开文件 |
| .md | Obsidian / VSCode | 用户可配置 |
| .docx / .xlsx / .pptx | Microsoft Office | 直接打开 |
| .pdf | 浏览器预览 | Web端直接预览 |
| .aedt (ANSYS) / .cst | ANSYS / CST Studio | 仿真文件 |

**验收标准**：
- ✅ 项目创建后，模板文件自动出现在本地工作目录
- ✅ 点击Web端.schdoc文件，本地Altium Designer正确打开对应本地文件
- ✅ 编辑保存后，辅助程序显示有未提交变更
- ✅ 用户在辅助程序中提交后，Gitea仓库正确更新
- ✅ Web端可看到新的git提交记录
- ✅ 辅助程序无响应时，Web端显示"请安装/启动桌面辅助程序"提示

---

### SRS-DEV-003: 活动执行与交付

**Phase**: 2  
**优先级**: P0

**描述**：
[MUST] 进入活动后，展示输出物模板列表、执行规范、参考资料（自动关联）。设计师通过Web点击模板开始工作，完成后标记文件完成、活动完成。

**活动执行流程**：
1. 设计师进入活动 → 状态自动变为"进行中" → 更新项目进度
2. 查看输出物模板列表 → 点击模板 → 调用本地软件打开本地文件进行编辑
3. 完成单个文件编辑 → 点击"文件完成" → 标记文件完成（仅本地状态，不提交Git）
4. 所有输出物完成 → 点击"活动完成" → 桌面辅助程序自动commit该活动所有变更文件 → 系统校验完成条件
5. 活动完成校验通过 → 自动触发下一活动 → 通知下一活动负责人

**活动完成时的Git自动提交**：
- 触发时机：用户点击"活动完成"且通过完成条件校验
- 执行者：桌面辅助程序
- Commit范围：该活动相关的所有输出文件变更
- Commit message格式：`完成活动"{活动名称}"：{项目编号}-{活动编号}`
- 示例：`完成活动"原理图设计"：RDP-001-ACT003`

**异常处理**：
- 如无本地文件变更：提示用户"未检测到文件变更，是否确认完成？"
- 如Git提交失败：活动状态保持"进行中"，提示用户解决冲突后重试

### SRS-DEV-004: DCP评审与审批

**Phase**: 2  
**优先级**: P0

**描述**：
[MUST] 关键节点（DCP决策检查点）支持审批流程。活动可配置为需要审批，审批通过后方可进入下一活动。

**审批流程**：
```
活动完成提交
    ↓
如需审批 → 状态变为"审批中"
    ↓
通知审批人
    ↓
审批人审核（通过/驳回）
    ↓
通过：触发下一活动
驳回：返回"进行中"，附审批意见
```

**审批配置**：
- 活动模板中可配置是否需要审批
- 审批人：项目负责人/技术负责人/部门领导（可配置）
- 审批方式：串行审批（多人依次）/ 并行审批（多人同时，全部通过）

**数据模型**：
```sql
TABLE approvals (
  id            ULID PRIMARY KEY,
  activity_id   ULID REFERENCES activities(id),
  applicant_id  ULID REFERENCES users(id),
  approver_id   ULID REFERENCES users(id),
  status        ENUM ('pending', 'approved', 'rejected'),
  comment       TEXT,
  created_at    TIMESTAMPTZ DEFAULT NOW(),
  updated_at    TIMESTAMPTZ DEFAULT NOW()
);
```

**API端点**：
- `POST /api/v1/activities/:id/submit-for-approval` → 提交审批
- `GET /api/v1/approvals/pending` → 获取待审批列表
- `PUT /api/v1/approvals/:id/approve` → 审批通过
- `PUT /api/v1/approvals/:id/reject` → 审批驳回

**验收标准**：
- ✅ 审批活动完成后进入"审批中"状态，冻结活动编辑
- ✅ 审批人收到通知，可在工作台查看待审批列表
- ✅ 审批通过自动触发下一活动，驳回返回并附审批意见
- ✅ 审批记录可追溯，显示审批人、时间、意见

---

**自动关联参考资料**：
[SHOULD] 根据项目类别和当前活动的标签，从知识库中自动匹配相关的参考项目、报告、论文、专利。匹配逻辑：标签交集 ≥ 2个 的知识条目按相关度排序展示。

**API端点**：
- `GET /api/v1/projects/:pid/activities/:aid` → 活动详情
- `PUT /api/v1/projects/:pid/activities/:aid/status` → `{"status": "completed"}`
- `GET /api/v1/projects/:pid/activities/:aid/templates` → 输出物模板列表
- `GET /api/v1/projects/:pid/activities/:aid/references` → 自动关联参考资料
- `POST /api/v1/projects/:pid/activities/:aid/deliverables` → 提交交付物
- `POST /api/v1/projects/:pid/activities/:aid/feedback` → 提交反馈/问题

**验收标准**：
- ✅ 点击"活动完成"后，桌面辅助程序自动执行Git commit + push
- ✅ Commit message格式正确，包含活动名称和编号
- ✅ Web端可看到新的git提交记录和commit hash
- ✅ 活动完成后自动触发下一活动（状态变为pending→可开始）
- ✅ 活动进度变更实时反映在项目管理模块的进度百分比中
- ✅ 参考资料自动关联 ≥ 3条相关条目（有数据时）
- ✅ 反馈/问题支持@通知和线程回复
- ✅ 无文件变更时提示用户确认，Git提交失败时保持活动状态并提示错误

---

## 8. SRS-SHELF — 产品货架模块

### SRS-SHELF-001: 产品浏览与筛选

**Phase**: 2  
**优先级**: P0

**描述**：
[MUST] 卡片式产品浏览页面，支持分类浏览（单机/模块/软件/基础）、多维筛选（类型/规格/成熟度/负责人）、关键词搜索。

**数据模型**：

```sql
TABLE products (
  id            ULID PRIMARY KEY,
  name          VARCHAR(200) NOT NULL,
  code          VARCHAR(50) UNIQUE,
  type          shelf_type NOT NULL,
  sub_type      basic_subtype,           -- 基础件适用
  maturity      product_maturity NOT NULL,
  description   TEXT,
  thumbnail_url VARCHAR(500),
  specs         JSONB,                   -- 技术规格参数
  tags          TEXT[],
  owner_id      ULID REFERENCES users(id),
  source_project_id ULID REFERENCES projects(id), -- 来源项目
  version       INT DEFAULT 1,
  parent_id     ULID REFERENCES products(id),      -- 版本链
  test_data     JSONB,                   -- 测试数据摘要
  usage_history JSONB DEFAULT '[]',      -- 应用履历
  issues        JSONB DEFAULT '[]',      -- 问题记录
  files_repo_id VARCHAR,                 -- Gitea仓库ID
  created_at    TIMESTAMPTZ DEFAULT NOW(),
  updated_at    TIMESTAMPTZ DEFAULT NOW()
);
```

**API端点**：
- `GET /api/v1/products?type=&maturity=&owner_id=&keyword=&tags=&page=1&page_size=20`
- `GET /api/v1/products/:id` → 产品详情（含测试数据、应用履历、问题记录等完整信息）
- `POST /api/v1/products` → 产品上架
- `POST /api/v1/products/:id/fork` → 基于产品创建新版本/新项目
- `POST /api/v1/cart/add` → `{"product_id": "xxx"}` 加入选用清单

**验收标准**：
- ✅ 产品卡片展示缩略图、名称、型号、成熟度徽章、负责人头像
- ✅ 支持≥4种筛选条件组合
- ✅ 产品详情页展示完整的测试数据和应用履历
- ✅ "加入选用清单"后可一键将资料包导入项目文件夹

---

## 9. SRS-TECH — 技术货架模块

### SRS-TECH-001: 技术树与详情

**Phase**: 2  
**优先级**: P0

**描述**：
[MUST] 树形/脑图展示部门技术体系。L1: 设计技术/试验技术/仿真技术。L2: 集成/天线/射频/数字/电源/嵌入式等。L3: 具体技术条目。每个技术条目含TRL等级、负责人、关联项目/文件数。

**API端点**：
- `GET /api/v1/technologies/tree` → 技术树结构
- `GET /api/v1/technologies/:id` → 技术详情
- `POST /api/v1/technologies/:id/fork` → fork创建新技术项目

**验收标准**：
- ✅ 技术树支持展开/折叠，至少3层深度
- ✅ 每个节点显示TRL等级徽章和条目数
- ✅ 点击技术条目展示完整详情（描述/文件/关联项目/负责人）

---

## 10. SRS-KB — 知识库模块

### SRS-KB-001: 知识分类与浏览

**Phase**: 3  
**优先级**: P0

**描述**：
[MUST] 多级分类体系浏览知识条目。分类树：理论知识(电子书/论文/专利/专业知识) | 标准规范(国标/国军标/航天/行业/部门) | 制度文件 | 流程说明(L1-L4) | 正反面案例 | 仿真模型 | 软件使用指南。

**数据模型**：

```sql
TABLE knowledge_items (
  id            ULID PRIMARY KEY,
  title         VARCHAR(300) NOT NULL,
  category      knowledge_category NOT NULL,
  sub_category  VARCHAR(100),        -- 二级分类
  tags          TEXT[] DEFAULT '{}',
  content       TEXT,                -- Markdown内容(如有)
  file_path     VARCHAR(500),        -- 文件存储路径
  file_type     VARCHAR(20),         -- pdf/md/docx/aedt/cst等
  obsidian_path VARCHAR(500),        -- Obsidian Vault对应路径
  zotero_key    VARCHAR(100),        -- Zotero条目Key
  author_id     ULID REFERENCES users(id),
  view_count    INT DEFAULT 0,
  download_count INT DEFAULT 0,
  status        VARCHAR(20) DEFAULT 'published',
  created_at    TIMESTAMPTZ DEFAULT NOW(),
  updated_at    TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_kb_tags ON knowledge_items USING GIN(tags);
CREATE INDEX idx_kb_category ON knowledge_items(category, sub_category);
```

**验收标准**：
- ✅ 分类树支持至少三级导航
- ✅ 条目支持按标签、分类、关键词筛选
- ✅ Markdown文件可Web端渲染预览（含公式、表格、代码高亮）
- ✅ PDF文件可Web端在线预览

---

### SRS-KB-002: Obsidian/Zotero集成

**Phase**: 3  
**优先级**: P0

**描述**：
[MUST] 知识库文件路径与Obsidian Vault保持一致。Web端可渲染Obsidian Markdown（含Wiki链接 `[[ ]]`、嵌入 `![[ ]]`、Callout等语法）。Zotero文献库的分类和条目可在Web端浏览，PDF可在线预览。

**Obsidian集成规格**：
- [MUST] Web端知识库根目录 = Obsidian Vault 根目录（路径映射配置）
- [MUST] 支持渲染：`[[WikiLink]]`、`![[嵌入]]`、`> [!NOTE] Callout`、YAML Front Matter
- [MUST] Web端编辑后，文件保存到Vault对应路径
- [SHOULD] 点击"在Obsidian中打开"调用 `obsidian://open?vault=xxx&file=xxx`

**Zotero集成规格**：
- [MUST] 读取Zotero本地数据库或WebDAV同步的文献数据
- [MUST] 展示Zotero分类结构和条目列表
- [SHOULD] 论文PDF在Web端在线预览

**验收标准**：
- ✅ Obsidian Wiki链接在Web端可正确跳转
- ✅ Obsidian Callout语法正确渲染为对应样式
- ✅ Zotero文献列表正确展示分类和条目
- ✅ 编辑保存的文件在Obsidian中可见（路径一致）

---

## 11. SRS-FORUM — 技术论坛

### SRS-FORUM-001: 论坛基础功能

**Phase**: 3  
**优先级**: P1

**描述**：
[SHOULD] 按技术领域分版块的技术交流论坛。支持富文本/Markdown发帖、回复、@提及、标签分类、全文搜索。

**板块结构**：
- 天线技术 | 射频技术 | 数字技术 | 电源技术 | 仿真技术 | 通用讨论 | 求助问答

**API端点**：
- `GET /api/v1/forum/boards` → 版块列表
- `GET /api/v1/forum/posts?board=&tag=&keyword=&page=1` → 帖子列表
- `POST /api/v1/forum/posts` → 发帖
- `POST /api/v1/forum/posts/:id/replies` → 回复
- `PUT /api/v1/forum/posts/:id/best-reply` → 标记最佳回复

**验收标准**：
- ✅ 发帖支持Markdown格式+图片上传+代码块
- ✅ @提及自动发送站内通知
- ✅ 最佳答案标记后置顶显示

---

## 12. SRS-NOTIFICATION — 通知系统

### SRS-NOTIFICATION-001: 站内通知

**Phase**: 1  
**优先级**: P0

**描述**：
[MUST] 内置通知系统，支持系统通知、项目通知、活动通知、审批通知等多种类型。用户在工作台可查看未读通知列表。

**通知类型**：
| 类型 | 触发场景 | 接收人 |
|------|----------|--------|
| **系统通知** | 系统公告、维护提醒 | 全部用户 |
| **项目通知** | 项目创建、成员变更、状态变更 | 项目成员 |
| **活动通知** | 活动分配、即将到期、活动完成 | 活动负责人 |
| **审批通知** | 审批待办、审批结果 | 审批人/申请人 |

**API端点**：
- `GET /api/v1/notifications?unread=true&page=1` → 通知列表
- `PUT /api/v1/notifications/:id/read` → 标记已读
- `PUT /api/v1/notifications/read-all` → 全部已读
- `DELETE /api/v1/notifications/:id` → 删除通知

**验收标准**：
- ✅ 通知实时推送（WebSocket或轮询）
- ✅ 未读通知数实时显示在工作台
- ✅ 点击通知跳转到对应页面
- ✅ 支持通知批量已读和清空

---

## 13. SRS-IM — 即时通信

### SRS-IM-001: Mattermost集成

**Phase**: 3  
**优先级**: P1

**描述**：
[SHOULD] 部署Mattermost Team Edition，通过Nginx反向代理集成到平台。SSO与Casdoor对接，实现统一登录。项目创建时自动创建Mattermost频道。

**集成方式**：
- [SHOULD] Mattermost通过 `/chat/*` 路径代理，iframe嵌入或独立Tab打开
- [SHOULD] OAuth2/OpenID Connect对接Casdoor，实现SSO
- [SHOULD] 通过Mattermost API自动创建项目频道
- [SHOULD] 配置Incoming Webhook接收项目状态变更通知

**自动化集成**：

```javascript
// 项目创建后自动执行:
1. POST /api/v4/channels → 创建频道 (name=project-{code})
2. POST /api/v4/channels/{id}/members → 添加项目成员
3. POST /api/v4/posts → 发送欢迎消息 "项目{name}已创建，欢迎团队成员！"

// 项目状态变更时:
POST /hooks/{webhook_id} → "项目{name}状态更新为{status}"
```

**验收标准**：
- ✅ 平台登录后无需再次登录Mattermost（SSO生效）
- ✅ 项目创建后Mattermost自动出现对应频道
- ✅ 频道成员与项目团队成员一致
- ✅ 项目状态变更消息自动推送到频道

---

## 14. SRS-SECURITY — 安全合规模块

### SRS-SECURITY-001: 数据分级分类

**Phase**: 1  
**优先级**: P0

**描述**：
[MUST] 对系统内的项目文档、知识库内容进行密级标注（公开/内部/秘密/机密），不同密级有不同的访问和导出权限。

**数据模型**：

```sql
TABLE data_classification (
  id            ULID PRIMARY KEY,
  resource_type VARCHAR(50) NOT NULL,     -- project/knowledge/file
  resource_id   ULID NOT NULL,
  level         VARCHAR(20) NOT NULL,     -- public/internal/secret/confidential
  owner_id      ULID REFERENCES users(id),
  approved_by   ULID REFERENCES users(id), -- 定密审批人
  approved_at   TIMESTAMPTZ,
  watermark     BOOLEAN DEFAULT false,     -- 是否启用水印
  export_limit  JSONB DEFAULT '{}',        -- 导出限制配置
  created_at    TIMESTAMPTZ DEFAULT NOW(),
  updated_at    TIMESTAMPTZ DEFAULT NOW()
);

-- 密级枚举
CREATE TYPE classification_level AS ENUM ('public', 'internal', 'secret', 'confidential');
```

**权限规则**：

| 密级 | 查看权限 | 导出权限 | 水印要求 |
|------|----------|----------|----------|
| **公开** | 全员 | 全员 | 否 |
| **内部** | 部门成员 | 需审批 | 否 |
| **秘密** | 项目成员 | 部门领导审批 | 是 |
| **机密** | 指定人员 | 部门领导+保密办审批 | 是 |

**API端点**：
- `GET /api/v1/classification/:resource_type/:resource_id` → 获取密级信息
- `POST /api/v1/classification` → 设置密级 [Admin/Owner]
- `POST /api/v1/classification/:id/approve` → 审批密级 [Admin]

**验收标准**：
- ✅ 项目创建时可选择密级，默认为"内部"
- ✅ 秘密/机密级文档下载时自动添加水印（用户名+时间）
- ✅ 低权限用户无法查看高密级内容（返回403）
- ✅ 密级变更需审批，记录变更日志

---

### SRS-SECURITY-002: 会话超时控制

**Phase**: 1  
**优先级**: P0

**描述**：
[MUST] 用户闲置超过设定时间（默认30分钟）自动退出，需重新登录，防止未授权访问。

**功能规格**：

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| **闲置超时** | 30分钟 | 无操作后自动登出 |
| **最大会话时长** | 8小时 | 强制重新登录 |
| **并发登录限制** | 3个 | 同一账号最大同时登录数 |

**超时流程**：
```
用户闲置 → 25分钟时弹出警告 → 30分钟自动登出 → 跳转登录页
              ↓
         用户点击"保持登录" → 重置计时器
```

**API端点**：
- `POST /api/v1/auth/heartbeat` → 客户端定期发送心跳，重置计时器
- `GET /api/v1/auth/session-info` → 获取当前会话剩余时间

**验收标准**：
- ✅ 闲置25分钟弹出警告提示
- ✅ 闲置30分钟自动登出，未保存数据不丢失（本地存储）
- ✅ 点击"保持登录"可延长会话
- ✅ 超过最大会话时长强制登出

---

### SRS-SECURITY-003: 操作审计日志

**Phase**: 1  
**优先级**: P0

**描述**：
[MUST] 记录所有敏感操作（登录、导出、权限变更、审批等），支持审计追溯。

**数据模型**：

```sql
TABLE audit_logs (
  id            ULID PRIMARY KEY,
  user_id       ULID REFERENCES users(id),
  action        VARCHAR(50) NOT NULL,      -- login/logout/export/permission_change
  resource_type VARCHAR(50),               -- project/knowledge/user
  resource_id   ULID,
  details       JSONB,                     -- 操作详情
  ip_address    INET,
  user_agent    VARCHAR(500),
  status        VARCHAR(20),               -- success/failure
  error_message TEXT,
  created_at    TIMESTAMPTZ DEFAULT NOW()
);

-- 分区策略：按月分区，保留12个月
CREATE TABLE audit_logs_2026_01 PARTITION OF audit_logs
    FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
```

**审计事件类型**：

| 事件 | 级别 | 记录内容 |
|------|------|----------|
| 用户登录/登出 | INFO | 时间、IP、结果 |
| 密码修改 | WARN | 时间、IP |
| 权限变更 | WARN | 变更前后、操作人 |
| 密级变更 | WARN | 原密级、新密级、审批人 |
| 文件导出 | INFO | 文件名、密级、审批状态 |
| 审批操作 | INFO | 审批类型、结果、意见 |

**API端点**：
- `GET /api/v1/audit-logs?action=&user_id=&from=&to=&page=1` → 审计日志查询 [Admin]
- `GET /api/v1/audit-logs/export` → 导出审计报告 [Admin]

**验收标准**：
- ✅ 所有敏感操作都有审计记录
- ✅ 日志不可篡改，仅Admin可查询
- ✅ 支持按时间、用户、操作类型筛选
- ✅ 日志保留策略自动执行（12个月归档）

---

### SRS-SECURITY-004: 屏幕水印

**Phase**: 2  
**优先级**: P1

**描述**：
[SHOULD] 涉密页面显示屏幕水印（用户名+时间），防止屏幕截图泄露。

**实现方式**：
- 前端CSS水印：覆盖整个页面，透明度5%
- 打印水印：打印涉密文档时自动添加页眉页脚水印
- 导出水印：下载文件时动态添加水印

**水印内容**：
```
{用户名} | {当前时间} | {IP地址}
```

**验收标准**：
- ✅ 秘密/机密级页面显示全屏水印
- ✅ 水印不影响正常阅读
- ✅ 打印/导出时自动添加水印
- ✅ 水印内容包含用户溯源信息

---

## 15. SRS-MONITOR — 运维监控模块

### SRS-MONITOR-001: 系统监控仪表盘

**Phase**: 4  
**优先级**: P1

**描述**：
[SHOULD] 可视化展示系统运行状态：CPU、内存、磁盘、网络、服务健康度。

**监控指标**：

| 类别 | 指标 | 采集频率 |
|------|------|----------|
| **系统** | CPU使用率、内存使用、磁盘IO、网络流量 | 15秒 |
| **数据库** | 连接数、慢查询、缓存命中率 | 30秒 |
| **应用** | QPS、响应时间、错误率、并发数 | 10秒 |
| **业务** | 在线用户数、操作频率 | 60秒 |

**仪表盘视图**：
- 实时指标卡片（当前值+趋势图）
- 服务健康状态（绿灯/黄灯/红灯）
- 告警事件列表
- 资源使用趋势（7天）

**API端点**：
- `GET /api/v1/monitor/metrics` → 获取实时指标
- `GET /api/v1/monitor/services` → 服务健康状态
- `GET /api/v1/monitor/dashboard` → 仪表盘数据聚合

**验收标准**：
- ✅ 仪表盘数据刷新频率 ≤ 30秒
- ✅ 服务异常时30秒内变更状态指示
- ✅ 支持查看历史趋势（7/30/90天）

---

### SRS-MONITOR-002: APM性能监控

**Phase**: 4  
**优先级**: P1

**描述**：
[SHOULD] 应用性能监控，追踪API响应时间、数据库查询耗时、慢请求分析。

**追踪维度**：

```
请求链路追踪：
HTTP Request → Middleware → Handler → Service → Database
   ↓              ↓          ↓         ↓          ↓
总耗时        中间件耗时   业务耗时   服务耗时    查询耗时
```

**慢请求阈值**：
- 普通API：> 500ms
- 复杂查询：> 2000ms
- 文件操作：> 5000ms

**API端点**：
- `GET /api/v1/monitor/apm/slow-queries` → 慢查询列表
- `GET /api/v1/monitor/apm/endpoints` → 端点性能统计
- `GET /api/v1/monitor/apm/traces/:trace_id` → 请求链路详情

**验收标准**：
- ✅ 自动记录超过阈值的慢请求
- ✅ 可追踪单个请求的完整调用链
- ✅ 数据库查询性能Top10统计

---

### SRS-MONITOR-003: 告警机制

**Phase**: 4  
**优先级**: P1

**描述**：
[SHOULD] 配置告警规则（如CPU>80%、服务宕机），通过邮件/站内通知发送告警。

**告警规则配置**：

```json
{
  "rules": [
    {
      "name": "CPU高负载",
      "metric": "system.cpu.usage",
      "operator": ">",
      "threshold": 80,
      "duration": "5m",
      "severity": "warning"
    },
    {
      "name": "服务不可用",
      "metric": "service.health",
      "operator": "==",
      "threshold": 0,
      "duration": "1m",
      "severity": "critical"
    }
  ]
}
```

**告警级别**：
- **Critical**：服务不可用，立即通知管理员
- **Warning**：性能下降，工作时间通知
- **Info**：一般事件，日报汇总

**通知方式**：
- 站内通知（所有级别）
- 邮件（Warning及以上）

**API端点**：
- `GET /api/v1/monitor/alerts` → 告警列表
- `POST /api/v1/monitor/alerts/:id/ack` → 确认告警
- `PUT /api/v1/monitor/rules` → 配置告警规则 [Admin]

**验收标准**：
- ✅ 告警触发延迟 ≤ 1分钟
- ✅ 支持告警静默期（避免重复通知）
- ✅ 告警可确认/解决/忽略
- ✅ 支持告警升级（长时间未处理提升级别）

---

### SRS-MONITOR-004: 日志集中管理

**Phase**: 4  
**优先级**: P1

**描述**：
[SHOULD] 收集各服务日志，集中存储和检索，支持关键字搜索和过滤。

**日志规范**：
- 结构化JSON格式
- 统一字段：timestamp, level, service, message, trace_id
- 分级：DEBUG/INFO/WARN/ERROR/FATAL

**日志收集架构**：
```
Application → Filebeat → Logstash → Elasticsearch → Kibana
                  ↓
              本地文件保留7天
```

**检索功能**：
- 关键字全文搜索
- 按时间范围筛选
- 按服务/级别过滤
- 上下文跳转（查看前后N行）

**API端点**：
- `GET /api/v1/monitor/logs?keyword=&service=&level=&from=&to=` → 日志搜索
- `GET /api/v1/monitor/logs/:id/context` → 获取上下文

**验收标准**：
- ✅ 日志检索延迟 ≤ 2秒（百万级数据）
- ✅ 支持复杂查询条件组合
- ✅ 可导出搜索结果

---

## 16. SRS-QM — 质量管理模块

### SRS-QM-001: 需求管理

**Phase**: 2  
**优先级**: P1

**描述**：
[SHOULD] 管理项目需求条目，支持需求分解、需求追溯、需求变更记录。

**数据模型**：

```sql
TABLE requirements (
  id            ULID PRIMARY KEY,
  project_id    ULID REFERENCES projects(id),
  parent_id     ULID REFERENCES requirements(id),  -- 父子分解
  code          VARCHAR(50) NOT NULL,              -- 需求编号 REQ-XXX
  title         VARCHAR(300) NOT NULL,
  description   TEXT,
  type          VARCHAR(20),                       -- functional/non-functional
  priority      VARCHAR(10),                       -- high/medium/low
  status        VARCHAR(20),                       -- draft/review/approved/baseline
  source        VARCHAR(100),                      -- 需求来源
  author_id     ULID REFERENCES users(id),
  reviewer_id   ULID REFERENCES users(id),
  verified_by   ULID REFERENCES users(id),
  created_at    TIMESTAMPTZ DEFAULT NOW(),
  updated_at    TIMESTAMPTZ DEFAULT NOW()
);

-- 需求追溯关系
TABLE requirement_traces (
  id              ULID PRIMARY KEY,
  source_id       ULID REFERENCES requirements(id),
  target_id       ULID REFERENCES requirements(id),
  relation_type   VARCHAR(20),  -- derive/satisfy/verify
  created_at      TIMESTAMPTZ DEFAULT NOW()
);
```

**功能规格**：
- 需求条目CRUD
- 需求树形分解（支持多级）
- 需求追溯矩阵（双向追溯）
- 需求变更历史
- 需求覆盖率统计

**API端点**：
- `GET /api/v1/projects/:id/requirements` → 需求列表（树形）
- `POST /api/v1/requirements` → 创建需求
- `PUT /api/v1/requirements/:id` → 更新需求
- `POST /api/v1/requirements/:id/trace` → 建立追溯关系
- `GET /api/v1/requirements/matrix` → 追溯矩阵视图

**验收标准**：
- ✅ 支持需求多级分解
- ✅ 变更时自动记录历史版本
- ✅ 追溯关系可视化展示
- ✅ 需求覆盖率统计（与测试用例关联）

---

### SRS-QM-002: 变更管理（ECR/ECO）

**Phase**: 2  
**优先级**: P1

**描述**：
[SHOULD] 工程变更申请（ECR）和工程变更指令（ECO）流程，支持影响分析和审批。

**变更流程**：
```
ECR提交 → 影响分析 → 审批 → ECO发布 → 实施 → 验证 → 关闭
```

**数据模型**：

```sql
-- 工程变更申请
TABLE change_requests (
  id            ULID PRIMARY KEY,
  project_id    ULID REFERENCES projects(id),
  code          VARCHAR(50) NOT NULL,      -- ECR-XXXX
  title         VARCHAR(300) NOT NULL,
  type          VARCHAR(20),               -- design/process/document
  reason        TEXT,                      -- 变更原因
  description   TEXT,                      -- 变更描述
  impact_scope  JSONB,                     -- 影响范围
  proposer_id   ULID REFERENCES users(id),
  status        VARCHAR(20),               -- draft/submitted/analyzing/approved/rejected
  created_at    TIMESTAMPTZ DEFAULT NOW(),
  updated_at    TIMESTAMPTZ DEFAULT NOW()
);

-- 工程变更指令
TABLE change_orders (
  id            ULID PRIMARY KEY,
  cr_id         ULID REFERENCES change_requests(id),
  code          VARCHAR(50) NOT NULL,      -- ECO-XXXX
  implementation_plan TEXT,                -- 实施计划
  verifier_id   ULID REFERENCES users(id),
  status        VARCHAR(20),               -- draft/approved/implemented/verified/closed
  created_at    TIMESTAMPTZ DEFAULT NOW()
);

-- 变更审批记录
TABLE change_approvals (
  id            ULID PRIMARY KEY,
  cr_id         ULID REFERENCES change_requests(id),
  approver_id   ULID REFERENCES users(id),
  decision      VARCHAR(20),               -- approve/reject
  comment       TEXT,
  created_at    TIMESTAMPTZ DEFAULT NOW()
);
```

**审批流程**：
| 变更类型 | 审批人 | 审批节点 |
|----------|--------|----------|
| 设计变更 | 技术负责人 | 影响分析→技术审批→质量审批→实施 |
| 流程变更 | 部门领导 | 提案→评审→批准→培训→实施 |
| 文档变更 | 质量负责人 | 校对→审核→批准→发布 |

**API端点**：
- `GET /api/v1/projects/:id/change-requests` → 变更申请列表
- `POST /api/v1/change-requests` → 提交ECR
- `POST /api/v1/change-requests/:id/analyze` → 提交影响分析
- `POST /api/v1/change-requests/:id/approve` → 审批
- `POST /api/v1/change-orders` → 创建ECO
- `PUT /api/v1/change-orders/:id/implement` → 标记实施完成

**验收标准**：
- ✅ ECR提交后自动通知审批人
- ✅ 支持变更影响分析文档上传
- ✅ 审批流程可配置
- ✅ 变更实施后可追溯

---

### SRS-QM-003: 缺陷管理

**Phase**: 2  
**优先级**: P1

**描述**：
[SHOULD] 记录和跟踪产品缺陷，支持缺陷分类、分配、修复验证闭环。

**数据模型**：

```sql
TABLE defects (
  id            ULID PRIMARY KEY,
  project_id    ULID REFERENCES projects(id),
  code          VARCHAR(50) NOT NULL,      -- BUG-XXXX
  title         VARCHAR(300) NOT NULL,
  description   TEXT,
  severity      VARCHAR(10),               -- critical/major/minor/trivial
  priority      VARCHAR(10),               -- urgent/high/medium/low
  category      VARCHAR(50),               -- 缺陷分类
  found_in      VARCHAR(100),              -- 发现版本/阶段
  reporter_id   ULID REFERENCES users(id),
  assignee_id   ULID REFERENCES users(id),
  status        VARCHAR(20),               -- new/confirmed/fixing/fixed/verified/closed/reopened
  resolution    VARCHAR(50),               -- fixed/wont-fix/duplicate/invalid
  root_cause    TEXT,                      -- 根本原因分析
  fix_version   VARCHAR(50),               -- 修复版本
  verified_by   ULID REFERENCES users(id),
  verified_at   TIMESTAMPTZ,
  created_at    TIMESTAMPTZ DEFAULT NOW(),
  updated_at    TIMESTAMPTZ DEFAULT NOW()
);

-- 缺陷评论/活动记录
TABLE defect_activities (
  id            ULID PRIMARY KEY,
  defect_id     ULID REFERENCES defects(id),
  user_id       ULID REFERENCES users(id),
  action        VARCHAR(50),               -- create/assign/comment/fix/verify
  content       TEXT,
  created_at    TIMESTAMPTZ DEFAULT NOW()
);
```

**缺陷生命周期**：
```
New → Confirmed → Fixing → Fixed → Verified → Closed
 ↑                                    ↓
 └────────── Reopened ←───────────────┘
```

**API端点**：
- `GET /api/v1/projects/:id/defects` → 缺陷列表（支持筛选）
- `POST /api/v1/defects` → 提交缺陷
- `PUT /api/v1/defects/:id/assign` → 分配处理人
- `PUT /api/v1/defects/:id/status` → 更新状态
- `POST /api/v1/defects/:id/comment` → 添加评论

**验收标准**：
- ✅ 支持缺陷分级分类
- ✅ 状态变更自动通知相关人员
- ✅ 可查看缺陷处理历史
- ✅ 支持重复缺陷标记

---

### SRS-QM-004: 质量门禁

**Phase**: 2  
**优先级**: P1

**描述**：
[SHOULD] 在关键节点（DCP）设置质量检查项，未通过则阻止流程继续。

**门禁检查项**：

| 检查点 | 检查内容 | 门禁规则 |
|--------|----------|----------|
| **DCP1-概念决策** | 需求完成度、可行性分析 | 需求完成度≥90% |
| **DCP2-计划决策** | 方案评审通过率、风险识别 | 评审问题全部关闭 |
| **DCP3-开发完成** | 测试覆盖率、缺陷密度 | 严重缺陷=0，测试覆盖率≥80% |
| **DCP4-发布决策** | 遗留问题、文档完整性 | 遗留问题有规避措施 |

**数据模型**：

```sql
TABLE quality_gates (
  id            ULID PRIMARY KEY,
  project_id    ULID REFERENCES projects(id),
  dcp_type      VARCHAR(20) NOT NULL,      -- dcp1/dcp2/dcp3/dcp4
  check_items   JSONB NOT NULL,            -- 检查项列表
  status        VARCHAR(20),               -- pending/passed/failed/waived
  checked_by    ULID REFERENCES users(id),
  checked_at    TIMESTAMPTZ,
  waiver_reason TEXT,                      -- 豁免原因
  created_at    TIMESTAMPTZ DEFAULT NOW()
);
```

**API端点**：
- `GET /api/v1/projects/:id/quality-gates` → 质量门禁状态
- `POST /api/v1/quality-gates/:id/check` → 执行检查
- `POST /api/v1/quality-gates/:id/waive` → 申请豁免 [部门领导]

**验收标准**：
- ✅ 活动完成时自动触发门禁检查
- ✅ 检查不通过时阻止流程继续
- ✅ 支持门禁豁免申请（需审批）
- ✅ 门禁结果记录可追溯

---

## 17. 非功能规格

### 17.1 性能

| 类别 | 指标 | 要求 | 级别 |
|------|------|------|------|
| **性能** | 首屏加载 | ≤ 3秒（局域网） | [MUST] |
| | API响应 | 常规 ≤ 500ms，复杂查询 ≤ 2s | [MUST] |
| | 并发用户 | ≥ 50人同时在线 | [MUST] |
| | 文件上传 | 单文件 ≤ 500MB，支持断点续传 | [SHOULD] |
| **安全** | 认证 | JWT + 可选OTP二次验证 | [MUST] |
| | 传输加密 | TLS 1.2+（HTTPS） | [MUST] |
| | 密码存储 | bcrypt (cost ≥ 10) | [MUST] |
| | 审计日志 | 登录/权限变更/文件操作全量记录 | [MUST] |
| **可用性** | 系统可用性 | 工作时间 ≥ 99% | [MUST] |
| | 数据备份 | 每日自动备份，保留30天 | [MUST] |
| | 故障恢复 | RTO ≤ 1小时 | [MUST] |
| **可维护性** | 日志 | 结构化JSON日志，支持级别过滤 | [MUST] |
| | 健康检查 | 各服务 /health 端点 | [MUST] |
| | 配置管理 | 环境变量 + .env 文件，支持热重载 | [SHOULD] |

---

## 18. API 设计规范

### 18.1 统一响应格式

```json
// 成功响应
{
  "code": 200,
  "message": "success",
  "data": {},
  "timestamp": 1704067200000,
  "requestId": "req_xxxxxxxx"
}

// 分页响应
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [],
    "total": 100,
    "page": 1,
    "page_size": 20,
    "pages": 5
  },
  "timestamp": 1704067200000,
  "requestId": "req_xxxxxxxx"
}

// 错误响应
{
  "code": 6001,
  "message": "用户名已存在",
  "data": null,
  "timestamp": 1704067200000,
  "requestId": "req_xxxxxxxx"
}

// 错误码规范:
// 200  - SUCCESS
// 400  - BAD_REQUEST
// 401  - UNAUTHORIZED
// 403  - FORBIDDEN
// 404  - NOT_FOUND
// 500  - INTERNAL_ERROR
// 6xxx - 业务错误码
```

### 18.2 认证头格式

```
Authorization: Bearer {access_token}

// Token刷新:
POST /api/v1/auth/refresh
Body: { "refresh_token": "xxx" }
Response: { "access_token": "new_token", "expires_in": 7200 }
```

---

## 19. 验收测试矩阵

| 测试ID | 测试项 | 测试方法 | 通过标准 | 阶段 |
|--------|--------|----------|----------|------|
| AT-001 | 用户登录 | 输入正确用户名密码 | 成功跳转工作台，JWT有效 | P1 |
| AT-002 | 权限隔离 | 设计师访问管理页面 | 返回403，页面显示无权限 | P1 |
| AT-003 | 项目创建 | 5步向导完整走通 | 项目创建 + 标准目录 + 活动实例 | P1 |
| AT-004 | 甘特图交互 | 拖拽调整任务时间 | 依赖任务级联更新，数据持久化 | P2 |
| AT-005 | 本地软件调用 | 点击.schdoc文件 | Altium Designer打开对应文件 | P2 |
| AT-006 | Git自动提交 | 本地保存文件 | 30s内Gitea出现新commit | P2 |
| AT-007 | 活动流转 | 完成活动点击确认 | 下一活动激活，通知发送 | P2 |
| AT-008 | 产品选用 | 加入购物车+导入项目 | 产品文件包出现在项目文件夹 | P2 |
| AT-009 | 全文搜索 | 搜索关键词 | ≤500ms返回结果，中文分词正确 | P3 |
| AT-010 | Obsidian渲染 | 查看含WikiLink的MD | 链接可点击跳转，Callout正确渲染 | P3 |
| AT-011 | Mattermost SSO | 平台登录后访问Chat | 无需再次登录 | P3 |
| AT-012 | 并发测试 | 50用户同时操作 | API响应 ≤ 2s，无500错误 | P4 |
| AT-013 | 备份恢复 | 模拟数据库故障恢复 | 1小时内恢复，数据无丢失 | P4 |
| AT-014 | 贡献热力图 | 查看设计师Profile | 365天数据正确渲染 | P1 |
| AT-015 | 项目文件同步 | 上传文件到服务器 | 本地和服务器文件一致 | P2 |
| AT-016 | 数据分级分类 | 创建秘密级文档并以设计师访问 | 返回403且下载受限 | P1 |
| AT-017 | 会话超时 | 闲置30分钟后继续操作 | 自动登出并跳转登录页 | P1 |
| AT-018 | 审计追溯 | 执行权限变更后查询审计日志 | 记录完整且不可篡改 | P1 |
| AT-019 | 质量门禁 | DCP检查不通过后尝试流转 | 流程被阻止并提示原因 | P2 |
| AT-020 | 变更流程(ECR/ECO) | 提交ECR到审批通过 | 流程状态完整可追踪 | P2 |
| AT-021 | 缺陷闭环 | 提交缺陷至关闭 | 状态流转完整并通知相关人 | P2 |
| AT-022 | 监控告警 | 人工触发服务健康异常 | 1分钟内产生告警并可确认 | P4 |
| AT-023 | 日志检索 | 按trace_id搜索日志 | 2秒内返回结果并可查看上下文 | P4 |

---

## Agent 实现总结

本SRS共定义 **12大模块**、**30+功能规格**、**23个验收测试用例**

核心数据模型包含 **10个实体表**、**12种枚举类型**

API端点共计 **40+个RESTful端点**

集成的开源服务：**Casdoor、Casbin、Gitea、Mattermost、MeiliSearch**（按阶段引入）

实现时请严格按 **Phase 1→2→3→4** 的顺序推进，每个Phase结束时运行对应的验收测试

---

© 2026 微波研发部门 | 面向 Agent 集群实现
